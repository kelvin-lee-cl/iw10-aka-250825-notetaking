<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>AI workshop - AKA</title>
    <meta name="description"
        content="IW06: Storytelling is a 4-lesson AI workshop for students aged 8-9. Participants will learn to leverage generative AI tools for creative writing, and storytelling. Through hands-on exercises, students will unlock new realms of narrative possibility by generating original text, images, and audio to bring their stories to life. For those seeking deeper practice, a 12-hour IW06 Practicum is available to further enhance Gen-AI arts skills. This workshop offers a unique opportunity to explore the intersection of technology and imagination. Prepare for an extraordinary adventure in AI-powered storytelling.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/polyfills.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>




</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light px-5 fixed-top mb-3">
        <div class="d-flex align-items-center">
            <a class="navbar-brand flu_logo" href="https://future-leaders-union.odoo.com/zh_TW" target="_blank">
                <img class="mx-2" src="images/FLU_logo2.png" width="100" class="d-inline-block align-top" alt="">
            </a>
            <a class="navbar-brand school_logo" href="https://www.aka.org.hk/" target="_blank">
                <img src="/images/aka_logo.png" class="d-inline-block align-top" alt="AKA Logo" width="120"
                    height="auto">
            </a>
        </div>

        <!-- Centered User ID -->
        <div class="d-none position-absolute start-50 translate-middle-x" id="userIdDisplay"
            style="top: 30%; transform: translate(-50%, -50%); z-index: 1001; background: rgba(255,255,255,0.9);  border-radius: 6px; width:120px; margin-left:-10px;">
            <span class="nav-link fw-bold text-primary fs-6 m-0 p-0"></span>
        </div>


        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="justify-content-end collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ml-auto mx-2">
                <li class="nav-item ">
                    <a class="nav-link" href="index.html">Home</a>
                </li>
                <li class="nav-item d-none" id="classPptLink">
                    <a class="nav-link" href="classppt.html">Lessons</a>
                </li>

                <li class="nav-item d-none" id="exercise1">
                    <a class="nav-link" href="exercise1.html">1.å¿ƒæ™ºåœ–</a>
                </li>
                <li class="nav-item d-none" id="exercise2">
                    <a class="nav-link" href="exercise2.html">2.åœ–åƒç­†è¨˜</a>
                </li>
                <li class="nav-item active d-none" id="exercise3">
                    <a class="nav-link" href="exercise3.html">3.å­¸ç¿’å¡</a>
                </li>


                <button onclick="logout()" class="btn btn-secondary" style="display: none;"
                    id="logoutBtn">Logout</button>
            </ul>
        </div>
    </nav>
    <div style="display: flex; gap: 20px; padding: 20px; align-items: flex-start; max-width: 1200px; margin: 0 auto;">
        <div id="image1-container" style="flex: 2; transition: flex 0.3s ease; cursor: pointer;">
            <img id="image1" src="images/slides/12.png"
                style="width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border: 2px solid transparent; transition: all 0.3s ease;">
        </div>
        <div id="image2-container" style="flex: 1; transition: flex 0.3s ease; cursor: pointer;">
            <img id="image2" src="images/slides/15.png"
                style="width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border: 2px solid transparent; transition: all 0.3s ease;">
        </div>
    </div>
    <hr style="margin: 40px 0; border-color: #e0e0e0;">



    <!-- Flashcard Section -->
    <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 20px;">
        <div class="row">
            <div class="col-12">
                <h3 class="mb-4"
                    style="color: #333; font-weight: 600; border-bottom: 2px solid #28a745; padding-bottom: 10px;">
                    <i class="fas fa-layer-group me-2"></i>å­¸ç¿’å¡ç·´ç¿’
                    <a href="https://www.perplexity.ai/" target="_blank" class="btn btn-primary"
                        style="background-color: #007bff; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 500; transition: all 0.3s ease;">
                        <i class="fas fa-external-link-alt me-2"></i>é–‹å•Ÿ Perplexity AI
                    </a>
                </h3>

                <!-- Flashcard Input Section -->
                <div class="card mb-4" style="border: 2px solid #e0e0e0; border-radius: 12px;">

                    <div class="card-header" style="background-color: #f8f9fa; border-bottom: 1px solid #e0e0e0;">
                        <h5 class="mb-0" style="color: #333;">
                            <i class="fas fa-plus-circle me-2"></i>æ–°å¢å­¸ç¿’å¡
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="termInput" class="form-label" style="font-weight: 600; color: #555;">
                                        <i class="fas fa-tag me-2"></i>è¡“èª/æ¦‚å¿µ
                                    </label>
                                    <textarea id="termInput" class="form-control" rows="5"
                                        placeholder="è«‹è¼¸å…¥è¡“èªæˆ–æ¦‚å¿µ...&#10;å¯ä»¥ä¸€æ¬¡è²¼ä¸Šå¤šå€‹è¡“èªï¼Œæ¯è¡Œä¸€å€‹&#10;ä¾‹å¦‚ï¼š&#10;äººå·¥æ™ºèƒ½&#10;æ©Ÿå™¨å­¸ç¿’&#10;æ·±åº¦å­¸ç¿’"
                                        style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 12px; font-size: 16px; resize: vertical; height: 300px;"></textarea>
                                    <div class="form-text" style="color: #6c757d; font-size: 14px; margin-top: 5px;">
                                        <i class="fas fa-info-circle me-1"></i>å¯ä»¥ä¸€æ¬¡è²¼ä¸Šå¤šå€‹è¡“èªï¼Œæ¯è¡Œä¸€å€‹
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="definitionInput" class="form-label"
                                        style="font-weight: 600; color: #555;">
                                        <i class="fas fa-book me-2"></i>å®šç¾©/èªªæ˜
                                    </label>
                                    <textarea id="definitionInput" class="form-control" rows="5"
                                        placeholder="è«‹è¼¸å…¥å®šç¾©æˆ–èªªæ˜...&#10;å¯ä»¥ä¸€æ¬¡è²¼ä¸Šå¤šå€‹å®šç¾©ï¼Œæ¯è¡Œä¸€å€‹&#10;ä¾‹å¦‚ï¼š&#10;æ¨¡æ“¬äººé¡æ™ºèƒ½çš„æŠ€è¡“&#10;è®“æ©Ÿå™¨å¾æ•¸æ“šä¸­å­¸ç¿’çš„æ–¹æ³•&#10;ä½¿ç”¨å¤šå±¤ç¥ç¶“ç¶²çµ¡çš„æ©Ÿå™¨å­¸ç¿’"
                                        style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 12px; font-size: 16px; resize: vertical; height: 300px;"></textarea>
                                    <div class="form-text" style="color: #6c757d; font-size: 14px; margin-top: 5px;">
                                        <i class="fas fa-info-circle me-1"></i>å¯ä»¥ä¸€æ¬¡è²¼ä¸Šå¤šå€‹å®šç¾©ï¼Œæ¯è¡Œä¸€å€‹
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="text-end">
                            <button id="addFlashcardBtn" class="btn btn-primary"
                                style="background-color: #007bff; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 500;">
                                <i class="fas fa-plus me-2"></i>æ–°å¢å­¸ç¿’å¡
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Flashcard Actions -->
                <div class="d-flex gap-3 mb-4">
                    <button id="playFlashcardsBtn" class="btn btn-success" disabled
                        style="background-color: #28a745; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 500;">
                        <i class="fas fa-play me-2"></i>æ’­æ”¾å­¸ç¿’å¡
                    </button>
                    <button id="quizFlashcardsBtn" class="btn btn-warning" disabled
                        style="background-color: #ffc107; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 500; color: #212529;">
                        <i class="fas fa-question-circle me-2"></i>é–‹å§‹æ¸¬é©—
                    </button>
                    <button id="clearFlashcardsBtn" class="btn btn-outline-danger"
                        style="border: 2px solid #dc3545; padding: 12px 24px; border-radius: 8px; font-weight: 500; color: #dc3545;">
                        <i class="fas fa-trash me-2"></i>æ¸…ç©ºæ‰€æœ‰
                    </button>
                    <button id="generatePdfBtn" class="btn btn-info" disabled
                        style="background-color: #17a2b8; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 500; color: white;">
                        <i class="fas fa-file-pdf me-2"></i>ç”ŸæˆPDF
                    </button>
                </div>

                <!-- Flashcard Counter -->
                <div class="alert alert-info" id="flashcardCounter" style="display: none;">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="counterText">ç›®å‰æœ‰ 0 å¼µå­¸ç¿’å¡</span>
                </div>

                <!-- Flashcard List -->
                <div id="flashcardList" class="row g-3">
                    <!-- Flashcards will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Play Flashcard Modal -->
    <div class="modal fade" id="playFlashcardModal" tabindex="-1" aria-labelledby="playFlashcardModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="playFlashcardModalLabel">
                        <i class="fas fa-play me-2"></i>å­¸ç¿’å¡æ’­æ”¾
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="flashcard-display mb-4">
                        <div class="card" style="border: 3px solid #007bff; border-radius: 15px; min-height: 200px;">
                            <div class="card-body d-flex align-items-center justify-content-center">
                                <div id="flashcardContent" style="font-size: 18px; font-weight: 500;">
                                    é»æ“Šé–‹å§‹æ’­æ”¾å­¸ç¿’å¡
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flashcard-controls">
                        <button id="prevCardBtn" class="btn btn-outline-secondary me-2" disabled>
                            <i class="fas fa-chevron-left me-1"></i>ä¸Šä¸€å¼µ
                        </button>
                        <button id="flipCardBtn" class="btn btn-primary me-2">
                            <i class="fas fa-sync-alt me-1"></i>ç¿»è½‰
                        </button>
                        <button id="nextCardBtn" class="btn btn-outline-secondary">
                            ä¸‹ä¸€å¼µ<i class="fas fa-chevron-right ms-1"></i>
                        </button>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <span id="currentCardIndex">0</span> / <span id="totalCards">0</span>
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quiz Flashcard Modal -->
    <div class="modal fade" id="quizFlashcardModal" tabindex="-1" aria-labelledby="quizFlashcardModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="quizFlashcardModalLabel">
                        <i class="fas fa-question-circle me-2"></i>å­¸ç¿’å¡æ¸¬é©—
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Timer -->
                    <div class="text-center mb-3">
                        <div class="timer-display">
                            <span class="badge bg-warning text-dark" id="timerBadge" style="font-size: 16px;">
                                <i class="fas fa-clock me-1"></i>å‰©é¤˜æ™‚é–“: <span id="timerCount">10</span> ç§’
                            </span>
                        </div>
                    </div>

                    <!-- Score Display -->
                    <div class="text-center mb-3">
                        <span class="badge bg-success" style="font-size: 14px;">
                            å¾—åˆ†: <span id="quizScore">0</span>
                        </span>
                    </div>

                    <!-- Question -->
                    <div class="question-section mb-4">
                        <div class="card" style="border: 2px solid #28a745; border-radius: 12px;">
                            <div class="card-body">
                                <h6 class="card-title text-primary mb-3">
                                    <i class="fas fa-lightbulb me-2"></i>å®šç¾©/èªªæ˜
                                </h6>
                                <p id="quizQuestion" class="card-text" style="font-size: 16px; line-height: 1.6;">
                                    è¼‰å…¥ä¸­...
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Answer Options -->
                    <div class="answer-options">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <button class="btn btn-outline-primary w-100 answer-btn" data-index="0"
                                    style="height: 60px; font-size: 14px;">
                                    é¸é … A
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-outline-primary w-100 answer-btn" data-index="1"
                                    style="height: 60px; font-size: 14px;">
                                    é¸é … B
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-outline-primary w-100 answer-btn" data-index="2"
                                    style="height: 60px; font-size: 14px;">
                                    é¸é … C
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-outline-primary w-100 answer-btn" data-index="3"
                                    style="height: 60px; font-size: 14px;">
                                    é¸é … D
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Result Message -->
                    <div id="quizResult" class="alert mt-3" style="display: none;">
                        <!-- Result message will be shown here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">çµæŸæ¸¬é©—</button>
                    <button id="nextQuizBtn" class="btn btn-primary" style="display: none;">
                        ä¸‹ä¸€é¡Œ<i class="fas fa-arrow-right ms-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const image1Container = document.getElementById('image1-container');
            const image2Container = document.getElementById('image2-container');

            // Track which image is currently large (true = image1 is large, false = image2 is large)
            let image1IsLarge = true;

            function handleImageClick(event, container, imageId) {
                console.log('Clicked container:', imageId);
                console.log('Current state - image1IsLarge:', image1IsLarge);

                // Check if the clicked container is the currently large one
                const isCurrentImageLarge = (container === image1Container && image1IsLarge) ||
                    (container === image2Container && !image1IsLarge);

                console.log('Is large:', isCurrentImageLarge);

                if (isCurrentImageLarge) {
                    // If clicking the large image, show modal
                    console.log('Opening modal for:', imageId);
                    showImageModal(imageId);
                } else {
                    // If clicking the small image, make it large
                    console.log('Swapping sizes');
                    swapImageSizes();
                }
            }

            function swapImageSizes() {
                const currentFlex1 = image1Container.style.flex;
                const currentFlex2 = image2Container.style.flex;

                // Swap the flex values
                image1Container.style.flex = currentFlex2 || '1';
                image2Container.style.flex = currentFlex1 || '2';

                // Update the state tracking
                image1IsLarge = !image1IsLarge;
                console.log('Swapped sizes. New state - image1IsLarge:', image1IsLarge);
            }

            function showImageModal(imageId) {
                console.log('showImageModal called with:', imageId);

                const image = document.getElementById(imageId);
                if (!image) {
                    console.error('Image not found:', imageId);
                    return;
                }

                const imageSrc = image.src;
                console.log('Image source:', imageSrc);

                // Create modal HTML
                const modalHTML = `
                    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-fullscreen">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="imageModalLabel">å…¨è¢å¹•åœ–ç‰‡æª¢è¦–</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body d-flex justify-content-center align-items-center position-relative" style="background-color: #f8f9fa;">
                                    <img src="${imageSrc}" class="img-fluid" alt="Full size image" 
                                         style="max-width: 95vw; max-height: 90vh; width: auto; height: auto; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Remove existing modal if any
                const existingModal = document.getElementById('imageModal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Add modal to body
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                console.log('Modal HTML added to body');

                // Show modal
                try {
                    const modalElement = document.getElementById('imageModal');
                    if (modalElement) {
                        const modal = new bootstrap.Modal(modalElement);
                        modal.show();
                        console.log('Modal shown successfully');
                    } else {
                        console.error('Modal element not found after creation');
                    }
                } catch (error) {
                    console.error('Error showing modal:', error);
                }

                // Clean up modal after it's hidden
                document.getElementById('imageModal').addEventListener('hidden.bs.modal', function () {
                    this.remove();
                });
            }

            // Add click event listeners to both containers
            image1Container.addEventListener('click', (e) => handleImageClick(e, image1Container, 'image1'));
            image2Container.addEventListener('click', (e) => handleImageClick(e, image2Container, 'image2'));
        });


    </script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/e067495424.js" crossorigin="anonymous"></script>
    <script src="script.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-analytics.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-storage.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc, updateDoc, getDoc, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAOiceU8Lm9nVV3vtC78BVSdFSBbCS1aTY",
            authDomain: "aka-iw10-250825.firebaseapp.com",
            projectId: "aka-iw10-250825",
            storageBucket: "aka-iw10-250825.firebasestorage.app",
            messagingSenderId: "759880857162",
            appId: "1:759880857162:web:adbf8a30ca00a2e3b7d8b3",
            measurementId: "G-VW9JL4FJJ2"
        };

        // Initialize Firebase
        let app, storage;
        try {
            app = initializeApp(firebaseConfig);
            console.log("Firebase initialized successfully");

            // Initialize Analytics
            try {
                const analytics = getAnalytics(app);
                console.log("Firebase Analytics initialized");
            } catch (analyticsError) {
                console.warn("Analytics initialization failed:", analyticsError);
            }

            // Initialize Storage
            try {
                storage = getStorage(app);
                console.log("Firebase Storage initialized successfully");

                // Test storage access
                const testRef = ref(storage, ".connection_test");
                console.log("Storage reference created:", testRef);
            } catch (storageError) {
                console.error("Storage initialization failed:", storageError);
                alert("Firebaseå­˜å„²åˆå§‹åŒ–å¤±æ•—ï¼Œä¸Šå‚³åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨");
            }

            // Initialize Firestore
            try {
                const db = getFirestore(app);
                console.log("Firestore initialized successfully");
                window.fbDB = db;
            } catch (firestoreError) {
                console.error("Firestore initialization failed:", firestoreError);
                alert("Firestoreåˆå§‹åŒ–å¤±æ•—ï¼Œæäº¤åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨");
            }
        } catch (firebaseError) {
            console.error("Firebase initialization failed:", firebaseError);
            alert("Firebaseåˆå§‹åŒ–å¤±æ•—ï¼Œä¸Šå‚³åŠŸèƒ½ä¸å¯ç”¨");
        }

        // Make storage available globally
        window.fbStorage = storage;

        // Generate a random user ID if not already set
        if (!localStorage.getItem('currentUserId')) {
            const randomId = 'user_' + Math.random().toString(36).substring(2, 8);
            localStorage.setItem('currentUserId', randomId);
            console.log('Generated random user ID:', randomId);
        }

        // Function to get emoji for user ID
        function getEmojiForUserId(userId) {
            const kidFriendlyEmojis = [
                'ğŸŒŸ', 'ğŸŒˆ', 'ğŸ¦„', 'ğŸ±', 'ğŸ¶', 'ğŸ¦', 'ğŸ¼', 'ğŸ¨', 'ğŸ¦Š', 'ğŸ¦‹',
                'ğŸŒ¸', 'ğŸŒº', 'ğŸŒ»', 'ğŸŒ', 'â­', 'ğŸŒ™', 'â˜€ï¸', 'ğŸŒ¤ï¸', 'ğŸŒº', 'ğŸŒ·',
                'ğŸ€', 'ğŸŒ±', 'ğŸŒ³', 'ğŸŒ´', 'ğŸŒµ', 'ğŸŒ¿', 'ğŸ„', 'ğŸŒ¼', 'ğŸŒ»', 'ğŸŒ¹',
                'ğŸ¨', 'ğŸ­', 'ğŸª', 'ğŸ¯', 'ğŸ²'
            ];
            // Subtract 1 from userId since we want to start from 0
            const index = (parseInt(userId) - 1) % kidFriendlyEmojis.length;
            return kidFriendlyEmojis[index];
        }

        // Update user ID display in the navbar
        const userIdDisplay = document.getElementById('userIdDisplay');
        const currentUserId = localStorage.getItem('currentUserId');

        if (userIdDisplay && currentUserId) {
            userIdDisplay.textContent = `User ID: ${currentUserId} ${getEmojiForUserId(currentUserId)}`;
            userIdDisplay.classList.remove('d-none');
        }

        const nameInput = document.getElementById('name_1');
        if (nameInput) {
            nameInput.value = currentUserId;
        }

        const items = document.querySelectorAll('.text-item');
        const buttons = document.querySelectorAll('.btn');
        let currentIndex = 0;
        let rotationInterval; // Variable to hold the interval

        function rotateText() {
            items[currentIndex]?.classList.remove('active');
            currentIndex = (currentIndex + 1) % items.length;
            items[currentIndex]?.classList.add('active');
        }

        function showText(index) {
            const newIndex = parseInt(index);
            if (isNaN(newIndex) || newIndex < 0 || newIndex >= items.length) {
                console.warn('Invalid index:', index);
                return;
            }

            items[currentIndex]?.classList.remove('active');
            currentIndex = newIndex;
            items[currentIndex]?.classList.add('active');
        }

        function startRotation() {
            rotationInterval = setInterval(rotateText, 5000); // Change text every 3 seconds
        }

        function stopRotation() {
            clearInterval(rotationInterval); // Stop the rotation
        }

        // Start the rotation on page load
        startRotation();

        buttons.forEach(button => {
            button.addEventListener('mouseover', () => {
                stopRotation(); // Stop rotation on mouse over
                showText(button.getAttribute('data-index'));
            });
            button.addEventListener('mouseleave', () => {
                startRotation(); // Resume rotation on mouse leave
            });
        });

        // Font size variable for the rich text editor
        window.editorFontSize = 16; // Default font size (moved to global scope to avoid redeclaration)

        // Form handling for Prompt submissions
        const form1 = document.getElementById('dataForm_ws1');

        if (form1) {
            form1.addEventListener('submit', async function (event) {
                event.preventDefault();
                const textarea = form1.querySelector('textarea');
                const label = form1.querySelector('label');
                const promptText = textarea.value.trim();

                if (!promptText) {
                    alert('è«‹è¼¸å…¥Promptå…§å®¹å†æäº¤');
                    return;
                }

                const currentUserId = localStorage.getItem('currentUserId');
                if (!currentUserId) {
                    alert('è«‹å…ˆç™»å…¥æˆ–è¨­ç½®ç”¨æˆ¶ID');
                    return;
                }

                try {
                    // Show loading state
                    const submitBtn = form1.querySelector('button[type="submit"]');
                    const originalBtnText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'æäº¤ä¸­...';

                    // Add document to Firestore
                    const promptsCollection = collection(window.fbDB, 'prompts');
                    const newPrompt = {
                        text: promptText,
                        userId: currentUserId,
                        timestamp: serverTimestamp(),
                        createdAt: new Date().toISOString() // Backup for sorting if serverTimestamp fails
                    };

                    await addDoc(promptsCollection, newPrompt);

                    // Clear the form and show success message
                    textarea.value = '';
                    label.textContent = 'æˆåŠŸæäº¤! å¤šè¬æ‚¨çš„æç¤ºã€‚';

                    // Show alert to confirm submission
                    alert('æäº¤æˆåŠŸï¼');

                    // Refresh the prompts display
                    loadPrompts();
                } catch (error) {
                    console.error('Error submitting prompt:', error);
                    alert(`æäº¤å¤±æ•—: ${error.message}`);
                } finally {
                    // Restore button state
                    const submitBtn = form1.querySelector('button[type="submit"]');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'æäº¤æŒ‡ç¤º';
                }
            });
        }

        // In case dataForm_ws4 exists elsewhere in the document, keep a simplified version
        const form2 = document.getElementById('dataForm_ws4');
        if (form2) {
            form2.addEventListener('submit', function (event) {
                event.preventDefault();
                const input = form2.querySelector('input[type="url"]');
                const label = form2.querySelector('label');

                if (input) {
                    input.value = '';
                    if (label) label.textContent = 'æˆåŠŸæäº¤!';
                    alert('æäº¤æˆåŠŸï¼');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            const nameInput = document.getElementById('name');
            const currentUserId = localStorage.getItem('currentUserId');
            if (nameInput) {
                nameInput.value = currentUserId;
            }

            // Add keyboard event listeners
            document.addEventListener('keydown', function (e) {
                if (e.key === 'ArrowRight' && e.shiftKey) {
                    nameInput.classList.remove('d-none');
                }
            });

            document.addEventListener('keyup', function (e) {
                if (e.key === 'ArrowRight' && e.shiftKey) {
                    nameInput.classList.add('d-none');
                }
            });
        });

        document.addEventListener('DOMContentLoaded', function () {
            const imageUpload = document.getElementById('imageUpload');
            const imagePreview = document.getElementById('imagePreview');
            const uploadButton = document.getElementById('uploadButton');
            const imageName = document.getElementById('imageName');
            const uploadStatus = document.getElementById('uploadStatus');
            const uploadStatusMessage = document.getElementById('uploadStatusMessage');
            const uploadProgress = document.getElementById('uploadProgress');
            const displayUserId = document.getElementById('displayUserId');
            const changeUserIdBtn = document.getElementById('changeUserIdBtn');
            const testConnectionBtn = document.getElementById('testConnectionBtn');

            // Initialize prompts display
            loadPrompts();

            // Handle prompt edit modal
            const savePromptEditBtn = document.getElementById('savePromptEdit');
            if (savePromptEditBtn) {
                savePromptEditBtn.addEventListener('click', updatePrompt);
            }

            // Set up refresh button
            const refreshBtn = document.getElementById('refreshPrompts');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    refreshBtn.disabled = true;
                    const icon = refreshBtn.querySelector('i');
                    icon.classList.add('fa-spin');
                    loadPrompts().finally(() => {
                        setTimeout(() => {
                            refreshBtn.disabled = false;
                            icon.classList.remove('fa-spin');
                        }, 500);
                    });
                });
            }

            // Set up sort buttons
            const sortNewestBtn = document.getElementById('sortNewest');
            const sortOldestBtn = document.getElementById('sortOldest');

            if (sortNewestBtn) {
                sortNewestBtn.addEventListener('click', () => {
                    loadPrompts('desc');
                });
            }

            if (sortOldestBtn) {
                sortOldestBtn.addEventListener('click', () => {
                    loadPrompts('asc');
                });
            }

            // Function to test Firebase connectivity
            async function testFirebaseConnection() {
                if (!window.fbStorage) {
                    alert('Firebase å„²å­˜é‚„æœªåˆå§‹åŒ–');
                    return false;
                }

                try {
                    const testRef = ref(window.fbStorage, `.connection_test_${Date.now()}`);
                    const testBlob = new Blob(['connection_test'], { type: 'text/plain' });

                    // Try to upload a small test file
                    await uploadBytes(testRef, testBlob);

                    // Try to get the download URL
                    const downloadURL = await getDownloadURL(testRef);

                    console.log('Firebase connection test successful:', downloadURL);
                    alert('Firebase é€£æ¥æ¸¬è©¦æˆåŠŸï¼ä¸Šå‚³åŠŸèƒ½å·²æ­£å¸¸é‹ä½œã€‚');
                    return true;
                } catch (error) {
                    console.error('Firebase connection test failed:', error);

                    // Check if it's a permission error
                    if (error.code === 'storage/unauthorized') {
                        alert('Firebase é€£æ¥æ­£å¸¸ï¼Œä½†æ¬Šé™å—é™ã€‚è«‹è¯çµ¡ç®¡ç†å“¡ç²å–ä¸Šå‚³æ¬Šé™ã€‚');
                        return true; // Connection works, just permissions issue
                    } else {
                        alert(`Firebase é€£æ¥æ¸¬è©¦å¤±æ•—: ${error.message}`);
                        return false;
                    }
                }
            }

            // Add event listener for test connection button
            testConnectionBtn.addEventListener('click', function () {
                testFirebaseConnection();
            });

            // Update user ID display
            function updateUserIdDisplay() {
                const currentUserId = localStorage.getItem('currentUserId') || 'æœªè¨­ç½®';
                displayUserId.textContent = currentUserId;
            }

            // Initialize user ID display
            updateUserIdDisplay();

            // Handle user ID change button
            changeUserIdBtn.addEventListener('click', function () {
                const currentUserId = localStorage.getItem('currentUserId') || '';
                const newUserId = prompt('è«‹è¼¸å…¥æ–°çš„ç”¨æˆ¶ID:', currentUserId);
                if (newUserId && newUserId.trim() !== '') {
                    localStorage.setItem('currentUserId', newUserId.trim());
                    updateUserIdDisplay();
                    alert('ç”¨æˆ¶IDå·²æ›´æ–°!');
                }
            });

            // Preview images
            imageUpload.addEventListener('change', function (e) {
                imagePreview.innerHTML = ''; // Clear existing previews

                [...e.target.files].forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const preview = document.createElement('div');
                        preview.className = 'position-relative';
                        preview.innerHTML = `
                                                        <img src="${e.target.result}" style="max-width: 200px; max-height: 200px; object-fit: contain;">
                                                `;
                        imagePreview.appendChild(preview);
                    }
                    reader.readAsDataURL(file);
                });
            });

            // Handle upload
            uploadButton.addEventListener('click', async function () {
                const files = imageUpload.files;
                const currentUserId = localStorage.getItem('currentUserId');

                // Check for user ID
                if (!currentUserId) {
                    // Prompt the user to enter a user ID if not already set
                    const userId = prompt('è«‹è¼¸å…¥æ‚¨çš„ç”¨æˆ¶ID:');
                    if (!userId) {
                        alert('éœ€è¦ç”¨æˆ¶IDæ‰èƒ½ä¸Šå‚³åœ–ç‰‡');
                        return;
                    }
                    localStorage.setItem('currentUserId', userId);
                }

                if (!files.length || !imageName.value) {
                    alert('è«‹é¸æ“‡åœ–ç‰‡ä¸¦å…¥åç¨±');
                    return;
                }

                try {
                    uploadButton.disabled = true;
                    uploadButton.textContent = 'ä¸Šå‚³ä¸­...';
                    uploadStatus.classList.remove('d-none');
                    uploadStatusMessage.textContent = 'æº–å‚™ä¸Šå‚³...';

                    // Reset progress bar
                    uploadProgress.style.width = '0%';
                    uploadProgress.textContent = '0%';

                    // Test Firebase connection first
                    uploadStatusMessage.textContent = 'æª¢æŸ¥ Firebase é€£æ¥...';
                    try {
                        const testRef = ref(window.fbStorage, `.connection_test_${Date.now()}`);
                        const testBlob = new Blob(['connection_test'], { type: 'text/plain' });
                        await uploadBytes(testRef, testBlob);
                        uploadStatusMessage.textContent = 'Firebase é€£æ¥æˆåŠŸï¼Œé–‹å§‹ä¸Šå‚³...';
                    } catch (connectionError) {
                        // Check if it's a permission error
                        if (connectionError.code === 'storage/unauthorized') {
                            console.log('Firebase connection works but lacks permissions');
                            uploadStatusMessage.textContent = 'Firebase é€£æ¥æ­£å¸¸ï¼Œä½†æ¬Šé™å—é™ã€‚ç¹¼çºŒå˜—è©¦ä¸Šå‚³...';
                            // Continue with upload attempt anyway
                        } else {
                            throw new Error(`Firebase é€£æ¥å¤±æ•—: ${connectionError.message}`);
                        }
                    }

                    let successCount = 0;
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const timestamp = Date.now();
                        const fileName = `${currentUserId}_${imageName.value}_${timestamp}_${i}`;
                        const storageRef = ref(window.fbStorage, `stories/${fileName}`);

                        // Update progress status
                        const progressPercent = Math.round((i / files.length) * 100);
                        uploadProgress.style.width = `${progressPercent}%`;
                        uploadProgress.textContent = `${progressPercent}%`;
                        uploadStatusMessage.textContent = `æ­£åœ¨ä¸Šå‚³æ–‡ä»¶ ${i + 1}/${files.length}: ${file.name}`;

                        try {
                            await uploadBytes(storageRef, file);
                            const downloadURL = await getDownloadURL(storageRef);
                            console.log('File uploaded:', downloadURL);
                            successCount++;
                        } catch (fileError) {
                            console.error(`Error uploading ${file.name}:`, fileError);

                            // Check if it's a permission error
                            if (fileError.code === 'storage/unauthorized') {
                                uploadStatusMessage.textContent = `ä¸Šå‚³ ${file.name} å¤±æ•—: æ¬Šé™ä¸è¶³ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡`;
                            } else {
                                uploadStatusMessage.textContent = `ä¸Šå‚³ ${file.name} å¤±æ•—: ${fileError.message}`;
                            }
                        }
                    }

                    // Set progress to 100%
                    uploadProgress.style.width = '100%';
                    uploadProgress.textContent = '100%';

                    if (successCount === files.length) {
                        uploadStatusMessage.textContent = `å…¨éƒ¨ ${files.length} å€‹æ–‡ä»¶ä¸Šå‚³æˆåŠŸï¼`;
                        alert('åœ–ç‰‡ä¸Šå‚³æˆåŠŸï¼');
                    } else {
                        uploadStatusMessage.textContent = `æˆåŠŸä¸Šå‚³ ${successCount}/${files.length} å€‹æ–‡ä»¶ã€‚`;
                        alert(`éƒ¨åˆ†ä¸Šå‚³æˆåŠŸï¼š${successCount}/${files.length} å€‹æ–‡ä»¶`);
                    }

                    imageUpload.value = '';
                    imageName.value = '';
                    imagePreview.innerHTML = '';

                } catch (error) {
                    console.error('Upload error:', error);
                    uploadStatusMessage.textContent = `ä¸Šå‚³éŒ¯èª¤: ${error.message}`;
                    alert(`ä¸Šå‚³å¤±æ•—ï¼Œè«‹é‡è©¦: ${error.message}`);
                } finally {
                    uploadButton.disabled = false;
                    uploadButton.textContent = 'ä¸Šå‚³åœ–ç‰‡';
                    setTimeout(() => {
                        uploadStatus.classList.add('d-none'); // Hide status after a delay
                    }, 5000);
                }
            });
        });



        document.addEventListener('DOMContentLoaded', function () {
            const sectionTitle = document.getElementById('sectionTitle');
            const sections = document.querySelectorAll('.row.flex-grow-2.mt-5.fade-in');

            window.addEventListener('scroll', function () {
                // Find which section is currently in view
                let currentSection = null;
                let smallestDistance = Infinity;

                sections.forEach(section => {
                    const rect = section.getBoundingClientRect();
                    // Calculate distance from top of viewport
                    const distance = Math.abs(rect.top);

                    // Find the section closest to the top of the viewport
                    if (distance < smallestDistance) {
                        smallestDistance = distance;
                        currentSection = section;
                    }
                });

                // Update section title if we found a section
                if (currentSection) {
                    const sectionHeader = currentSection.querySelector('h4.mb-3');
                    // Show section title when any section is above the viewport
                    if (currentSection.getBoundingClientRect().top < 0) {
                        sectionTitle.textContent = sectionHeader.textContent;
                        sectionTitle.classList.remove('d-none');
                    } else {
                        sectionTitle.classList.add('d-none');
                    }
                }
            });
        });

        // Make openModal available globally
        window.openModal = function (presentationId) {
            const modal = new bootstrap.Modal(document.getElementById('presentationModal'));
            const container = document.getElementById('modalIframeContainer');

            // Define the iframe sources
            const presentations = {
                'presentation2': "https://docs.google.com/presentation/d/e/2PACX-1vR0N5eLd3d65nUFnFNtZp2HMlcOj0VPHmjnM4Jjq7u7SpTj1I-F0nrx1Np2Kiw1nQIu1-q6sJRv5R-S/pubembed?start=false&loop=false&delayms=3000"
            };

            // Create and insert the iframe
            container.innerHTML = `<iframe src="${presentations[presentationId]}" 
                                frameborder="0" 
                                width="100%" 
                                height="100%" 
                                allowfullscreen="true" 
                                mozallowfullscreen="true" 
                                webkitallowfullscreen="true">
                        </iframe>`;

            modal.show();
        };



        // Load stories from Firestore
        async function loadStories(sortDirection = 'desc') {
            const storiesContainer = document.getElementById('storiesContainer');
            const loadingStories = document.getElementById('loadingStories');

            console.log('Loading stories...', { storiesContainer: !!storiesContainer, fbDB: !!window.fbDB });

            if (!storiesContainer || !window.fbDB) {
                console.error('Missing required elements:', { storiesContainer: !!storiesContainer, fbDB: !!window.fbDB });
                return;
            }

            try {
                // Show loading indicator
                if (loadingStories) {
                    loadingStories.classList.remove('d-none');
                }

                // Clear existing content
                storiesContainer.innerHTML = '';

                // Get current user ID for permission checks
                const currentUserId = localStorage.getItem('currentUserId') || '';
                const isAdmin = currentUserId === 'M514';

                // Query stories, ordered by timestamp
                const storiesCollection = collection(window.fbDB, 'stories');
                const q = query(storiesCollection, orderBy('createdAt', sortDirection));
                const querySnapshot = await getDocs(q);

                // Hide loading indicator
                if (loadingStories) {
                    loadingStories.classList.add('d-none');
                }

                if (querySnapshot.empty) {
                    const noStoriesMsg = document.createElement('div');
                    noStoriesMsg.className = 'alert alert-secondary text-center';
                    noStoriesMsg.textContent = 'å°šæœªæœ‰äººæäº¤æ•…äº‹çµæ§‹';
                    storiesContainer.appendChild(noStoriesMsg);
                    return;
                }

                // Process each story document
                console.log(`Found ${querySnapshot.size} stories`);
                querySnapshot.forEach(doc => {
                    const storyData = doc.data();
                    const storyId = doc.id;
                    const canEdit = isAdmin || storyData.userId === currentUserId;

                    console.log('Processing story:', { storyId, userId: storyData.userId, content: storyData.content });

                    // Format timestamp
                    let timestampStr = 'å‰›å‰›';
                    if (storyData.timestamp) {
                        const timestamp = storyData.timestamp.toDate();
                        timestampStr = new Intl.DateTimeFormat('zh-HK', {
                            year: 'numeric',
                            month: 'numeric',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }).format(timestamp);
                    }

                    // Create story card
                    const storyCard = document.createElement('div');
                    storyCard.className = 'card mb-3 story-card';
                    storyCard.innerHTML = `
                        <div class="card-header d-flex justify-content-between align-items-center bg-light">
                            <span class="fw-semibold"><i class="fas fa-user-circle me-2"></i>${storyData.userId || 'åŒ¿å'}</span>
                            <small class="text-muted"><i class="far fa-clock me-1"></i>${timestampStr}</small>
                        </div>
                        <div class="card-body">
                            <div class="story-content">
                                <h6 class="text-primary mb-2"><i class="fas fa-book me-2"></i>æ•…äº‹å…§å®¹</h6>
                                <div class="card-text" style="white-space: pre-wrap; line-height: 1.6;">${storyData.content.replace(/\n/g, '<br>')}</div>
                            </div>
                            ${canEdit ? `
                            <div class="text-end mt-3">
                                <button class="btn btn-sm btn-outline-danger delete-story-btn" data-id="${storyId}">
                                    <i class="fas fa-trash me-1"></i>åˆªé™¤
                                </button>
                            </div>
                            ` : ''}
                        </div>
                    `;

                    storiesContainer.appendChild(storyCard);

                    // Add delete functionality
                    const deleteBtn = storyCard.querySelector('.delete-story-btn');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', function () {
                            const storyId = this.getAttribute('data-id');
                            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ•…äº‹å—ï¼Ÿ')) {
                                deleteStory(storyId);
                            }
                        });
                    }
                });

            } catch (error) {
                console.error('Error loading stories:', error);
                if (loadingStories) {
                    loadingStories.classList.add('d-none');
                }

                const errorMsg = document.createElement('div');
                errorMsg.className = 'alert alert-danger';

                // Handle Firebase permission errors
                if (error.code === 'permission-denied' || error.message.includes('permission')) {
                    errorMsg.textContent = 'Firebase æ¬Šé™ä¸è¶³ã€‚è«‹è¯çµ¡ç®¡ç†å“¡ç²å–è®€å–æ¬Šé™ã€‚';
                } else {
                    errorMsg.textContent = `è¼‰å…¥æ•…äº‹å¤±æ•—: ${error.message}`;
                }

                storiesContainer.appendChild(errorMsg);
            }
        }

        // Delete story function
        async function deleteStory(storyId) {
            try {
                const storyRef = doc(window.fbDB, 'stories', storyId);
                await deleteDoc(storyRef);
                alert('æ•…äº‹å·²åˆªé™¤');
                loadStories();
            } catch (error) {
                console.error('Error deleting story:', error);
                alert(`åˆªé™¤å¤±æ•—: ${error.message}`);
            }
        }

        // Initialize story functionality when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            // Story Structure Form Handling
            const storyStructureForm = document.getElementById('storyStructureForm');
            if (storyStructureForm) {
                storyStructureForm.addEventListener('submit', async function (event) {
                    event.preventDefault();

                    const storyContent = document.getElementById('storyContent').value.trim();

                    // Check if story content is provided
                    if (!storyContent) {
                        alert('è«‹å¡«å¯«æ•…äº‹å…§å®¹');
                        return;
                    }

                    const currentUserId = localStorage.getItem('currentUserId');
                    if (!currentUserId) {
                        alert('è«‹å…ˆç™»å…¥æˆ–è¨­ç½®ç”¨æˆ¶ID');
                        return;
                    }

                    try {
                        // Show loading state
                        const submitBtn = storyStructureForm.querySelector('button[type="submit"]');
                        const originalBtnText = submitBtn.innerHTML;
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>æäº¤ä¸­...';

                        console.log('Submitting story:', { content: storyContent, userId: currentUserId });

                        // Check if Firebase is available
                        if (!window.fbDB) {
                            throw new Error('Firebase æœªåˆå§‹åŒ–ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦');
                        }

                        // Add story to Firestore
                        const storiesCollection = collection(window.fbDB, 'stories');
                        const newStory = {
                            content: storyContent,
                            userId: currentUserId,
                            timestamp: serverTimestamp(),
                            createdAt: new Date().toISOString()
                        };

                        console.log('Adding story to Firestore:', newStory);
                        const docRef = await addDoc(storiesCollection, newStory);
                        console.log('Story saved with ID:', docRef.id);

                        // Clear the form
                        storyStructureForm.reset();

                        // Show success message
                        alert('æ•…äº‹çµæ§‹ä¿å­˜æˆåŠŸï¼');

                        // Refresh the stories display
                        loadStories();

                    } catch (error) {
                        console.error('Error saving story:', error);

                        // Handle Firebase permission errors
                        if (error.code === 'permission-denied' || error.message.includes('permission')) {
                            alert('Firebase æ¬Šé™ä¸è¶³ã€‚è«‹è¯çµ¡ç®¡ç†å“¡ç²å–å¯«å…¥æ¬Šé™ã€‚');
                        } else {
                            alert(`ä¿å­˜å¤±æ•—: ${error.message}`);
                        }
                    } finally {
                        // Restore button state
                        const submitBtn = storyStructureForm.querySelector('button[type="submit"]');
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalBtnText;
                        }
                    }
                });
            } else {
                console.error('Story structure form not found');
            }

            // Load stories on page load
            loadStories();

            // Set up refresh button
            const refreshStoriesBtn = document.getElementById('refreshStories');
            if (refreshStoriesBtn) {
                refreshStoriesBtn.addEventListener('click', () => {
                    refreshStoriesBtn.disabled = true;
                    const icon = refreshStoriesBtn.querySelector('i');
                    icon.classList.add('fa-spin');
                    loadStories().finally(() => {
                        setTimeout(() => {
                            refreshStoriesBtn.disabled = false;
                            icon.classList.remove('fa-spin');
                        }, 500);
                    });
                });
            }

            // Set up sort button
            const sortStoriesNewestBtn = document.getElementById('sortStoriesNewest');
            if (sortStoriesNewestBtn) {
                sortStoriesNewestBtn.addEventListener('click', () => {
                    loadStories('desc');
                });
            }
        });

        // Add copyToClipboard function if it doesn't exist
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('å·²è¤‡è£½åˆ°å‰ªè²¼æ¿');
            }).catch(err => {
                console.error('è¤‡è£½å¤±æ•—:', err);
                alert('è¤‡è£½å¤±æ•—');
            });
        }

        // Testing code for debugging purposes
        console.log("Script initialized");

        // Excalidraw Submission System
        document.addEventListener('DOMContentLoaded', function () {
            const submitBtn = document.getElementById('submitBtn');
            const excalidrawLink = document.getElementById('excalidrawLink');
            const previewBtn = document.getElementById('previewBtn');
            const previewSection = document.getElementById('previewSection');
            const previewFrame = document.getElementById('previewFrame');
            const submissionsContainer = document.getElementById('submissionsContainer');
            const loadingSubmissions = document.getElementById('loadingSubmissions');

            if (!submitBtn || !excalidrawLink || !previewBtn || !previewSection || !previewFrame || !submissionsContainer || !loadingSubmissions) {
                console.log('Excalidraw elements not found, skipping initialization');
                return;
            }

            console.log('Initializing Excalidraw system...');

            // Preview functionality
            previewBtn.addEventListener('click', function () {
                const link = excalidrawLink.value.trim();
                if (!link) {
                    alert('è«‹å…ˆè¼¸å…¥ Excalidraw é€£çµ');
                    return;
                }

                if (!isValidExcalidrawLink(link)) {
                    alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Excalidraw é€£çµ');
                    return;
                }

                previewSection.style.display = 'block';
                previewFrame.innerHTML = `
                    <iframe src="${link}" 
                            style="width: 100%; height: 500px; border: none;" 
                            allowfullscreen>
                    </iframe>
                `;
            });

            // Submit functionality
            submitBtn.addEventListener('click', async function () {
                const link = excalidrawLink.value.trim();
                const currentUserId = localStorage.getItem('currentUserId');

                if (!link) {
                    alert('è«‹å…ˆè¼¸å…¥ Excalidraw é€£çµ');
                    return;
                }

                if (!isValidExcalidrawLink(link)) {
                    alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Excalidraw é€£çµ');
                    return;
                }

                if (!currentUserId) {
                    alert('è«‹å…ˆè¨­ç½®ç”¨æˆ¶ID');
                    return;
                }

                try {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>æäº¤ä¸­...';

                    // Add submission to Firestore
                    const submissionsCollection = collection(window.fbDB, 'image_notes_submissions');
                    const newSubmission = {
                        link: link,
                        userId: currentUserId,
                        timestamp: serverTimestamp(),
                        createdAt: new Date().toISOString()
                    };

                    await addDoc(submissionsCollection, newSubmission);

                    // Clear form
                    excalidrawLink.value = '';
                    previewSection.style.display = 'none';
                    previewFrame.innerHTML = '';

                    alert('ä½œå“æäº¤æˆåŠŸï¼');

                    // Refresh submissions display
                    loadSubmissions();

                } catch (error) {
                    console.error('Error submitting:', error);
                    alert(`æäº¤å¤±æ•—: ${error.message}`);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>æäº¤ä½œå“';
                }
            });

            // Load submissions
            async function loadSubmissions() {
                try {
                    console.log('Loading Image Notes submissions...');
                    const submissionsCollection = collection(window.fbDB, 'image_notes_submissions');
                    const q = query(submissionsCollection, orderBy('createdAt', 'desc'));
                    const querySnapshot = await getDocs(q);

                    // Hide loading
                    loadingSubmissions.style.display = 'none';

                    if (querySnapshot.empty) {
                        submissionsContainer.innerHTML = `
                            <div class="col-12 text-center" style="color: #6c757d; padding: 40px;">
                                <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                                <p>å°šæœªæœ‰å­¸ç”Ÿæäº¤ä½œå“</p>
                            </div>
                        `;
                        return;
                    }

                    // Get current user ID for permission checks
                    const currentUserId = localStorage.getItem('currentUserId') || '';
                    const adminIds = ['180', '280', '380', '480', '580'];
                    const isAdmin = adminIds.includes(currentUserId);

                    submissionsContainer.innerHTML = '';
                    querySnapshot.forEach(doc => {
                        const submission = doc.data();
                        const submissionCard = createSubmissionCard(submission, doc.id, currentUserId, isAdmin);
                        submissionsContainer.appendChild(submissionCard);
                    });

                    console.log(`Loaded ${querySnapshot.size} submissions`);

                } catch (error) {
                    console.error('Error loading submissions:', error);
                    loadingSubmissions.innerHTML = `
                        <div class="col-12 text-center" style="color: #dc3545; padding: 40px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                            <p>è¼‰å…¥å¤±æ•—: ${error.message}</p>
                        </div>
                    `;
                }
            }

            // Create submission card
            function createSubmissionCard(submission, docId, currentUserId, isAdmin) {
                // Check if user can delete this submission (admin or own submission)
                const canDelete = isAdmin || submission.userId === currentUserId;

                const card = document.createElement('div');
                card.className = 'col-md-6 col-lg-4';
                card.innerHTML = `
                    <div class="card h-100" style="border: 1px solid #e0e0e0; border-radius: 12px; overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease;">
                        <div class="card-header" style="background-color: #f8f9fa; border-bottom: 1px solid #e0e0e0;">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-semibold" style="color: #333;">
                                    <i class="fas fa-user-circle me-2"></i>${submission.userId || 'åŒ¿å'}
                                </span>
                                <small class="text-muted">
                                    <i class="far fa-clock me-1"></i>${formatTimestamp(submission.timestamp)}
                                </small>
                            </div>
                        </div>
                        <div class="card-body p-0" style="height: 300px;">
                            <iframe src="${submission.link}" 
                                    style="width: 100%; height: 100%; border: none;" 
                                    allowfullscreen>
                            </iframe>
                        </div>
                        <div class="card-footer" style="background-color: #fff; border-top: 1px solid #e0e0e0; padding: 15px;">
                            <div class="d-flex justify-content-between align-items-center">
                                <a href="${submission.link}" target="_blank" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-external-link-alt me-1"></i>åœ¨æ–°è¦–çª—é–‹å•Ÿ
                                </a>
                                ${canDelete ? `
                                <button class="btn btn-sm btn-outline-danger delete-submission" data-id="${docId}">
                                    <i class="fas fa-trash me-1"></i>åˆªé™¤
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;

                // Add delete functionality only if user can delete
                if (canDelete) {
                    const deleteBtn = card.querySelector('.delete-submission');
                    deleteBtn.addEventListener('click', function () {
                        if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ä½œå“å—ï¼Ÿ')) {
                            deleteSubmission(docId);
                        }
                    });
                }

                return card;
            }

            // Delete submission
            async function deleteSubmission(docId) {
                try {
                    const submissionRef = doc(window.fbDB, 'image_notes_submissions', docId);
                    await deleteDoc(submissionRef);
                    alert('ä½œå“å·²åˆªé™¤');
                    loadSubmissions();
                } catch (error) {
                    console.error('Error deleting submission:', error);
                    alert(`åˆªé™¤å¤±æ•—: ${error.message}`);
                }
            }

            // Helper functions
            function isValidExcalidrawLink(link) {
                return link.includes('excalidraw.com') || link.includes('excalidraw.app');
            }

            function formatTimestamp(timestamp) {
                if (!timestamp) return 'å‰›å‰›';
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return new Intl.DateTimeFormat('zh-HK', {
                    year: 'numeric',
                    month: 'numeric',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }).format(date);
            }

            // Initialize
            console.log('Starting Image Notes submissions load...');
            loadSubmissions();
        });

    </script>
    <script>
        // Flashcard System
        class FlashcardSystem {
            constructor() {
                this.flashcards = JSON.parse(localStorage.getItem('flashcards') || '[]');
                this.currentCardIndex = 0;
                this.isShowingTerm = true;
                this.quizScore = 0;
                this.currentQuizQuestion = null;
                this.timer = null;
                this.timeLeft = 10;

                this.initializeElements();
                this.bindEvents();
                this.updateDisplay();
            }

            initializeElements() {
                // Input elements
                this.termInput = document.getElementById('termInput');
                this.definitionInput = document.getElementById('definitionInput');
                this.addFlashcardBtn = document.getElementById('addFlashcardBtn');

                // Action buttons
                this.playFlashcardsBtn = document.getElementById('playFlashcardsBtn');
                this.quizFlashcardsBtn = document.getElementById('quizFlashcardsBtn');
                this.clearFlashcardsBtn = document.getElementById('clearFlashcardsBtn');
                this.generatePdfBtn = document.getElementById('generatePdfBtn');

                // Display elements
                this.flashcardCounter = document.getElementById('flashcardCounter');
                this.counterText = document.getElementById('counterText');
                this.flashcardList = document.getElementById('flashcardList');

                // Play modal elements
                this.flashcardContent = document.getElementById('flashcardContent');
                this.prevCardBtn = document.getElementById('prevCardBtn');
                this.flipCardBtn = document.getElementById('flipCardBtn');
                this.nextCardBtn = document.getElementById('nextCardBtn');
                this.currentCardIndexSpan = document.getElementById('currentCardIndex');
                this.totalCardsSpan = document.getElementById('totalCards');

                // Quiz modal elements
                this.timerCount = document.getElementById('timerCount');
                this.quizScoreSpan = document.getElementById('quizScore');
                this.quizQuestion = document.getElementById('quizQuestion');
                this.answerBtns = document.querySelectorAll('.answer-btn');
                this.quizResult = document.getElementById('quizResult');
                this.nextQuizBtn = document.getElementById('nextQuizBtn');
            }

            initializeModals() {
                // Initialize modals after DOM is fully loaded
                try {
                    this.playModal = new bootstrap.Modal(document.getElementById('playFlashcardModal'));
                    this.quizModal = new bootstrap.Modal(document.getElementById('quizFlashcardModal'));
                } catch (error) {
                    console.warn('Modal initialization failed, will retry when needed:', error);
                }
            }

            getPlayModal() {
                if (!this.playModal) {
                    this.playModal = new bootstrap.Modal(document.getElementById('playFlashcardModal'));
                }
                return this.playModal;
            }

            getQuizModal() {
                if (!this.quizModal) {
                    this.quizModal = new bootstrap.Modal(document.getElementById('quizFlashcardModal'));
                }
                return this.quizModal;
            }

            bindEvents() {
                // Add flashcard
                this.addFlashcardBtn.addEventListener('click', () => this.addFlashcard());

                // Action buttons
                this.playFlashcardsBtn.addEventListener('click', () => this.startPlayMode());
                this.quizFlashcardsBtn.addEventListener('click', () => this.startQuizMode());
                this.clearFlashcardsBtn.addEventListener('click', () => this.clearAllFlashcards());
                this.generatePdfBtn.addEventListener('click', () => this.generatePdf());

                // Play modal controls
                this.prevCardBtn.addEventListener('click', () => this.previousCard());
                this.flipCardBtn.addEventListener('click', () => this.flipCard());
                this.nextCardBtn.addEventListener('click', () => this.nextCard());

                // Quiz controls
                this.answerBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => this.selectAnswer(e.target));
                });
                this.nextQuizBtn.addEventListener('click', () => this.nextQuizQuestion());

                // Enter key to add flashcard
                this.termInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.addFlashcard();
                });
                this.definitionInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.addFlashcard();
                });
            }

            addFlashcard() {
                const termText = this.termInput.value.trim();
                const definitionText = this.definitionInput.value.trim();

                if (!termText || !definitionText) {
                    alert('è«‹å¡«å¯«è¡“èªå’Œå®šç¾©');
                    return;
                }

                // Split by line breaks and filter out empty lines
                const terms = termText.split('\n').map(t => t.trim()).filter(t => t.length > 0);
                const definitions = definitionText.split('\n').map(d => d.trim()).filter(d => d.length > 0);

                // Check if we have matching numbers of terms and definitions
                if (terms.length !== definitions.length) {
                    alert(`è¡“èªæ•¸é‡ (${terms.length}) èˆ‡å®šç¾©æ•¸é‡ (${definitions.length}) ä¸åŒ¹é…ï¼Œè«‹ç¢ºä¿æ¯è¡Œéƒ½æœ‰å°æ‡‰çš„å…§å®¹`);
                    return;
                }

                if (terms.length === 0) {
                    alert('è«‹å¡«å¯«è¡“èªå’Œå®šç¾©');
                    return;
                }

                // Create flashcards for each term-definition pair
                let createdCount = 0;
                for (let i = 0; i < terms.length; i++) {
                    const flashcard = {
                        id: Date.now() + i, // Ensure unique IDs
                        term: terms[i],
                        definition: definitions[i],
                        createdAt: new Date().toISOString()
                    };

                    this.flashcards.push(flashcard);
                    createdCount++;
                }

                this.saveFlashcards();
                this.updateDisplay();

                // Clear inputs
                this.termInput.value = '';
                this.definitionInput.value = '';
                this.termInput.focus();

                // Show success message
                const message = createdCount === 1 ? 'å­¸ç¿’å¡æ–°å¢æˆåŠŸï¼' : `æˆåŠŸæ–°å¢ ${createdCount} å¼µå­¸ç¿’å¡ï¼`;
                this.showToast(message, 'success');
            }

            deleteFlashcard(id) {
                if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å¼µå­¸ç¿’å¡å—ï¼Ÿ')) {
                    this.flashcards = this.flashcards.filter(card => card.id !== id);
                    this.saveFlashcards();
                    this.updateDisplay();
                    this.showToast('å­¸ç¿’å¡å·²åˆªé™¤', 'info');
                }
            }

            clearAllFlashcards() {
                if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å­¸ç¿’å¡å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                    this.flashcards = [];
                    this.saveFlashcards();
                    this.updateDisplay();
                    this.showToast('æ‰€æœ‰å­¸ç¿’å¡å·²æ¸…ç©º', 'warning');
                }
            }

            saveFlashcards() {
                localStorage.setItem('flashcards', JSON.stringify(this.flashcards));
            }

            updateDisplay() {
                const count = this.flashcards.length;

                // Update counter
                if (count > 0) {
                    this.flashcardCounter.style.display = 'block';
                    this.counterText.textContent = `ç›®å‰æœ‰ ${count} å¼µå­¸ç¿’å¡`;
                } else {
                    this.flashcardCounter.style.display = 'none';
                }

                // Update action buttons
                this.playFlashcardsBtn.disabled = count < 1;
                this.quizFlashcardsBtn.disabled = count < 4;
                this.generatePdfBtn.disabled = count < 1;

                // Update flashcard list
                this.renderFlashcardList();
            }

            renderFlashcardList() {
                this.flashcardList.innerHTML = '';

                this.flashcards.forEach(card => {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'col-md-6 col-lg-4';
                    cardElement.innerHTML = `
                        <div class="card h-100" style="border: 1px solid #e0e0e0; border-radius: 12px; transition: transform 0.3s ease;">
                            <div class="card-header" style="background-color: #f8f9fa; border-bottom: 1px solid #e0e0e0;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-semibold" style="color: #333;">
                                        <i class="fas fa-tag me-2"></i>è¡“èª
                                    </span>
                                    <button class="btn btn-sm btn-outline-danger delete-flashcard" data-id="${card.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <h6 class="card-title text-primary mb-2">${card.term}</h6>
                                <p class="card-text" style="color: #666; line-height: 1.5;">${card.definition}</p>
                                <small class="text-muted">
                                    <i class="far fa-clock me-1"></i>${new Date(card.createdAt).toLocaleDateString('zh-TW')}
                                </small>
                            </div>
                        </div>
                    `;

                    // Add delete event listener
                    const deleteBtn = cardElement.querySelector('.delete-flashcard');
                    deleteBtn.addEventListener('click', () => this.deleteFlashcard(card.id));

                    this.flashcardList.appendChild(cardElement);
                });
            }

            startPlayMode() {
                if (this.flashcards.length === 0) return;

                this.currentCardIndex = 0;
                this.isShowingTerm = true;
                this.updatePlayDisplay();
                this.getPlayModal().show();
            }

            updatePlayDisplay() {
                const card = this.flashcards[this.currentCardIndex];
                this.flashcardContent.textContent = this.isShowingTerm ? card.term : card.definition;
                this.currentCardIndexSpan.textContent = this.currentCardIndex + 1;
                this.totalCardsSpan.textContent = this.flashcards.length;

                // Update navigation buttons
                this.prevCardBtn.disabled = this.currentCardIndex === 0;
                this.nextCardBtn.disabled = this.currentCardIndex === this.flashcards.length - 1;
            }

            previousCard() {
                if (this.currentCardIndex > 0) {
                    this.currentCardIndex--;
                    this.isShowingTerm = true;
                    this.updatePlayDisplay();
                }
            }

            nextCard() {
                if (this.currentCardIndex < this.flashcards.length - 1) {
                    this.currentCardIndex++;
                    this.isShowingTerm = true;
                    this.updatePlayDisplay();
                }
            }

            flipCard() {
                this.isShowingTerm = !this.isShowingTerm;
                this.updatePlayDisplay();
            }

            startQuizMode() {
                if (this.flashcards.length < 4) {
                    alert('éœ€è¦è‡³å°‘ 4 å¼µå­¸ç¿’å¡æ‰èƒ½é–‹å§‹æ¸¬é©—');
                    return;
                }

                this.quizScore = 0;
                this.quizScoreSpan.textContent = this.quizScore;
                this.getQuizModal().show();
                this.nextQuizQuestion();
            }

            nextQuizQuestion() {
                // Hide result message
                this.quizResult.style.display = 'none';
                this.nextQuizBtn.style.display = 'none';

                // Reset timer
                this.timeLeft = 10;
                this.timerCount.textContent = this.timeLeft;

                // Clear previous timer
                if (this.timer) {
                    clearInterval(this.timer);
                }

                // Generate quiz question
                this.generateQuizQuestion();

                // Start timer
                this.startTimer();
            }

            generateQuizQuestion() {
                // Randomly select a flashcard for the question
                const questionIndex = Math.floor(Math.random() * this.flashcards.length);
                const questionCard = this.flashcards[questionIndex];

                this.currentQuizQuestion = {
                    question: questionCard.definition,
                    correctAnswer: questionCard.term,
                    correctIndex: 0
                };

                // Generate 4 answer options (1 correct + 3 random)
                const otherTerms = this.flashcards
                    .filter((_, index) => index !== questionIndex)
                    .map(card => card.term);

                // Shuffle other terms and take 3
                const shuffledTerms = this.shuffleArray([...otherTerms]);
                const wrongAnswers = shuffledTerms.slice(0, 3);

                // Create answer options array
                const answerOptions = [questionCard.term, ...wrongAnswers];
                this.shuffleArray(answerOptions);

                // Find the index of correct answer
                this.currentQuizQuestion.correctIndex = answerOptions.indexOf(questionCard.term);

                // Update display
                this.quizQuestion.textContent = questionCard.definition;

                // Update answer buttons
                this.answerBtns.forEach((btn, index) => {
                    btn.textContent = answerOptions[index];
                    btn.className = 'btn btn-outline-primary w-100 answer-btn';
                    btn.disabled = false;
                });
            }

            startTimer() {
                this.timer = setInterval(() => {
                    this.timeLeft--;
                    this.timerCount.textContent = this.timeLeft;

                    if (this.timeLeft <= 0) {
                        clearInterval(this.timer);
                        this.handleTimeout();
                    }
                }, 1000);
            }

            handleTimeout() {
                // Disable all answer buttons
                this.answerBtns.forEach(btn => btn.disabled = true);

                // Show correct answer
                this.answerBtns[this.currentQuizQuestion.correctIndex].className = 'btn btn-success w-100 answer-btn';

                // Show result message
                this.showQuizResult('æ™‚é–“åˆ°ï¼', 'warning', false);
            }

            selectAnswer(button) {
                // Clear timer
                if (this.timer) {
                    clearInterval(this.timer);
                }

                // Disable all buttons
                this.answerBtns.forEach(btn => btn.disabled = true);

                const selectedIndex = parseInt(button.getAttribute('data-index'));
                const isCorrect = selectedIndex === this.currentQuizQuestion.correctIndex;

                // Update button styles
                if (isCorrect) {
                    button.className = 'btn btn-success w-100 answer-btn';
                } else {
                    button.className = 'btn btn-danger w-100 answer-btn';
                    this.answerBtns[this.currentQuizQuestion.correctIndex].className = 'btn btn-success w-100 answer-btn';
                }

                // Update score
                if (isCorrect) {
                    this.quizScore++;
                    this.quizScoreSpan.textContent = this.quizScore;
                }

                // Show result message
                const message = isCorrect ? 'ç­”å°äº†ï¼' : 'ç­”éŒ¯äº†ï¼';
                this.showQuizResult(message, isCorrect ? 'success' : 'danger', isCorrect);
            }

            showQuizResult(message, type, isCorrect) {
                this.quizResult.className = `alert alert-${type} mt-3`;
                this.quizResult.innerHTML = `
                    <i class="fas fa-${isCorrect ? 'check-circle' : 'times-circle'} me-2"></i>
                    ${message} æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š<strong>${this.currentQuizQuestion.correctAnswer}</strong>
                `;
                this.quizResult.style.display = 'block';

                // Show next button
                this.nextQuizBtn.style.display = 'inline-block';
            }

            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            showToast(message, type = 'info') {
                // Create toast element
                const toast = document.createElement('div');
                toast.className = `alert alert-${type} position-fixed`;
                toast.style.cssText = `
                    top: 20px; right: 20px; z-index: 9999; 
                    min-width: 300px; border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                `;
                toast.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                `;

                document.body.appendChild(toast);

                // Remove toast after 3 seconds
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 3000);
            }

            generatePdf() {
                if (this.flashcards.length === 0) {
                    this.showToast('æ²’æœ‰å­¸ç¿’å¡å¯ä»¥ç”ŸæˆPDF', 'warning');
                    return;
                }

                try {
                    // Show loading message
                    this.showToast('æ­£åœ¨ç”ŸæˆPDF...', 'info');

                    // Step 1: HTML Generation with proper font loading
                    this.createPdfWithFontLoading();

                } catch (error) {
                    console.error('Error generating PDF:', error);
                    this.showToast('PDFç”Ÿæˆå¤±æ•—: ' + error.message, 'danger');
                }
            }

            createPdfWithFontLoading() {
                // Create temporary HTML container
                const tempContainer = document.createElement('div');
                tempContainer.style.cssText = `
                    position: absolute; 
                    left: -9999px; 
                    top: -9999px; 
                    width: 800px; 
                    background: white; 
                    padding: 20px; 
                    font-family: 'Microsoft JhengHei', 'PingFang TC', 'Helvetica Neue', Arial, sans-serif;
                    font-size: 14px;
                    line-height: 1.5;
                `;
                document.body.appendChild(tempContainer);

                // Generate HTML content with Chinese text
                let htmlContent = `
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h1 style="color: #333; margin: 0; font-size: 24px; font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;">å­¸ç¿’å¡</h1>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                `;

                this.flashcards.forEach((card, index) => {
                    htmlContent += `
                        <div style="border: 2px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 20px; min-height: 120px; background: white; font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;">
                            <div style="font-weight: bold; color: #007bff; margin-bottom: 8px; font-size: 14px;">#${index + 1} è¡“èª:</div>
                            <div style="font-size: 16px; line-height: 1.4; margin-bottom: 15px; word-wrap: break-word;">${card.term}</div>
                            <div style="font-weight: bold; color: #28a745; margin-bottom: 8px; font-size: 14px;">å®šç¾©:</div>
                            <div style="font-size: 14px; line-height: 1.4; word-wrap: break-word;">${card.definition}</div>
                        </div>
                    `;
                });

                htmlContent += '</div>';
                tempContainer.innerHTML = htmlContent;

                // Step 2: Wait for fonts to load, then convert to canvas
                this.waitForFontsToLoad().then(() => {
                    // Step 3: HTML to Canvas conversion
                    html2canvas(tempContainer, {
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff',
                        logging: true, // Enable logging for debugging
                        width: 800,
                        height: tempContainer.scrollHeight,
                        onclone: (clonedDoc) => {
                            // Ensure fonts are applied in cloned document
                            const allElements = clonedDoc.querySelectorAll('*');
                            allElements.forEach(element => {
                                element.style.fontFamily = 'Microsoft JhengHei, PingFang TC, Helvetica Neue, Arial, sans-serif';
                            });
                        }
                    }).then(canvas => {
                        // Step 4: Canvas to PDF conversion
                        this.convertCanvasToPdf(canvas, tempContainer);
                    }).catch(error => {
                        console.error('Canvas generation error:', error);
                        this.showToast('PDFç”Ÿæˆå¤±æ•—: Canvas ç”ŸæˆéŒ¯èª¤', 'danger');
                        document.body.removeChild(tempContainer);
                    });
                }).catch(error => {
                    console.error('Font loading error:', error);
                    this.showToast('PDFç”Ÿæˆå¤±æ•—: å­—é«”è¼‰å…¥éŒ¯èª¤', 'danger');
                    document.body.removeChild(tempContainer);
                });
            }

            waitForFontsToLoad() {
                return new Promise((resolve, reject) => {
                    // Check if fonts are available
                    const testString = 'å­¸ç¿’å¡æ¸¬è©¦æ–‡å­—';
                    const testElement = document.createElement('div');
                    testElement.style.cssText = `
                        position: absolute;
                        left: -9999px;
                        top: -9999px;
                        font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
                        font-size: 16px;
                    `;
                    testElement.textContent = testString;
                    document.body.appendChild(testElement);

                    // Wait a bit for fonts to load
                    setTimeout(() => {
                        document.body.removeChild(testElement);
                        resolve();
                    }, 500);
                });
            }

            convertCanvasToPdf(canvas, tempContainer) {
                try {
                    // Create PDF from canvas (image)
                    const { jsPDF } = window.jspdf;
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');

                    const imgWidth = 210; // A4 width in mm
                    const pageHeight = 295; // A4 height in mm
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    // Add first page
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    // Add additional pages if needed
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    // Save the PDF
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    pdf.save(`å­¸ç¿’å¡_${timestamp}.pdf`);

                    // Clean up
                    document.body.removeChild(tempContainer);

                    this.showToast('PDFç”ŸæˆæˆåŠŸï¼', 'success');
                } catch (error) {
                    console.error('PDF generation error:', error);
                    this.showToast('PDFç”Ÿæˆå¤±æ•—: PDF ç”ŸæˆéŒ¯èª¤', 'danger');
                    document.body.removeChild(tempContainer);
                }
            }

            splitTextForPdf(text, maxWidth) {
                // Simple character-based splitting for Chinese text
                const charsPerLine = Math.floor(maxWidth / 3); // Approximate for Chinese characters
                const lines = [];
                let currentLine = '';

                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    if (currentLine.length >= charsPerLine) {
                        lines.push(currentLine);
                        currentLine = char;
                    } else {
                        currentLine += char;
                    }
                }

                if (currentLine) {
                    lines.push(currentLine);
                }

                return lines.slice(0, 6); // Limit to 6 lines per card
            }

            splitTextToFit(text, maxWidth, doc) {
                const words = text.split(' ');
                const lines = [];
                let currentLine = '';

                for (let word of words) {
                    const testLine = currentLine + (currentLine ? ' ' : '') + word;
                    const testWidth = doc.getTextWidth(testLine);

                    if (testWidth <= maxWidth) {
                        currentLine = testLine;
                    } else {
                        if (currentLine) {
                            lines.push(currentLine);
                            currentLine = word;
                        } else {
                            // Word is too long, force break
                            lines.push(word);
                        }
                    }
                }

                if (currentLine) {
                    lines.push(currentLine);
                }

                return lines;
            }
        }

        // Initialize flashcard system when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            // Wait a bit to ensure Bootstrap is fully loaded
            setTimeout(() => {
                window.flashcardSystem = new FlashcardSystem();
            }, 100);
        });
    </script>

    <script>
    </script>
</body>

</html>