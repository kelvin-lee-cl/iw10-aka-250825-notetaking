<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>AI workshop - AKA</title>
    <meta name="description"
        content="IW06: Storytelling is a 4-lesson AI workshop for students aged 8-9. Participants will learn to leverage generative AI tools for creative writing, and storytelling. Through hands-on exercises, students will unlock new realms of narrative possibility by generating original text, images, and audio to bring their stories to life. For those seeking deeper practice, a 12-hour IW06 Practicum is available to further enhance Gen-AI arts skills. This workshop offers a unique opportunity to explore the intersection of technology and imagination. Prepare for an extraordinary adventure in AI-powered storytelling.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="styles.css">




</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light px-5 fixed-top mb-3">
        <div class="d-flex align-items-center">
            <a class="navbar-brand flu_logo" href="https://future-leaders-union.odoo.com/zh_TW" target="_blank">
                <img class="mx-2" src="images/FLU_logo2.png" width="100" class="d-inline-block align-top" alt="">
            </a>
            <a class="navbar-brand school_logo" href="https://www.aka.org.hk/" target="_blank">
                <img src="/images/aka_logo.png" class="d-inline-block align-top" alt="AKA Logo" width="120"
                    height="auto">
            </a>
        </div>

        <!-- Centered User ID -->
        <div class="d-none position-absolute start-50 translate-middle-x" id="userIdDisplay"
            style="top: 30%; transform: translate(-50%, -50%); z-index: 1001; background: rgba(255,255,255,0.9);  border-radius: 6px; width:120px; margin-left:50px;">
            <span class="nav-link fw-bold text-primary fs-6 m-0 p-0"></span>
        </div>


        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="justify-content-end collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ml-auto mx-2">
                <li class="nav-item ">
                    <a class="nav-link" href="index.html">Home</a>
                </li>
                <li class="nav-item d-none" id="classPptLink">
                    <a class="nav-link" href="classppt.html">Lessons</a>
                </li>

                <li class="nav-item d-none" id="exercise1">
                    <a class="nav-link" href="exercise1.html">1.å¿ƒæ™ºåœ–</a>
                </li>
                <li class="nav-item active d-none" id="exercise2">
                    <a class="nav-link" href="exercise2.html">2.åœ–åƒç­†è¨˜</a>
                </li>
                <li class="nav-item d-none" id="exercise3">
                    <a class="nav-link" href="exercise3.html">3.å­¸ç¿’å¡</a>
                </li>


                <button onclick="logout()" class="btn btn-secondary" style="display: none;"
                    id="logoutBtn">Logout</button>
            </ul>
        </div>
    </nav>
    <div style="display: flex; gap: 20px; padding: 20px; align-items: flex-start; max-width: 1200px; margin: 0 auto;">
        <div id="image1-container" style="flex: 2; transition: flex 0.3s ease; cursor: pointer;">
            <img id="image1" src="images/slides/10.png"
                style="width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border: 2px solid transparent; transition: all 0.3s ease;">
        </div>
        <div id="image2-container" style="flex: 1; transition: flex 0.3s ease; cursor: pointer;">
            <img id="image2" src="images/slides/12.png"
                style="width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border: 2px solid transparent; transition: all 0.3s ease;">
        </div>
    </div>
    <hr style="margin: 40px 0; border-color: #e0e0e0;">

    <!-- Excalidraw Section -->
    <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 20px;">
        <div class="row">
            <div class="col-12">
                <h3 class="mb-4"
                    style="color: #333; font-weight: 600; border-bottom: 2px solid #007bff; padding-bottom: 10px;">
                    <i class="fas fa-pencil-alt me-2"></i>åœ–åƒç­†è¨˜ç·´ç¿’ - Excalidraw
                </h3>

                <!-- Action Buttons -->
                <div class="d-flex gap-3 mb-4">
                    <a href="https://excalidraw.com/" target="_blank" class="btn btn-primary"
                        style="background-color: #007bff; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 500; transition: all 0.3s ease;">
                        <i class="fas fa-external-link-alt me-2"></i>é–‹å•Ÿ Excalidraw
                    </a>
                    <button id="submitBtn" class="btn btn-success"
                        style="background-color: #28a745; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 500; transition: all 0.3s ease;">
                        <i class="fas fa-paper-plane me-2"></i>æäº¤ä½œå“
                    </button>
                </div>

                <!-- Link Input -->
                <div class="mb-4">
                    <label for="excalidrawLink" class="form-label"
                        style="font-weight: 600; color: #555; margin-bottom: 8px;">
                        <i class="fas fa-link me-2"></i>Excalidraw é€£çµ
                    </label>
                    <div class="input-group">
                        <input type="url" id="excalidrawLink" class="form-control" placeholder="è«‹è²¼ä¸Šæ‚¨çš„ Excalidraw é€£çµ..."
                            style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 12px; font-size: 16px; transition: border-color 0.3s ease;">
                        <button class="btn btn-outline-secondary" type="button" id="previewBtn"
                            style="border: 2px solid #e0e0e0; border-left: none; border-radius: 0 8px 8px 0; padding: 12px 16px;">
                            <i class="fas fa-eye me-1"></i>é è¦½
                        </button>
                    </div>
                    <div class="form-text" style="color: #6c757d; font-size: 14px; margin-top: 5px;">
                        <i class="fas fa-info-circle me-1"></i>è«‹ç¢ºä¿é€£çµæ˜¯å…¬é–‹å¯è¨ªå•çš„
                    </div>
                </div>

                <!-- Preview Section -->
                <div id="previewSection" class="mb-4" style="display: none;">
                    <h5 style="color: #333; margin-bottom: 15px;">
                        <i class="fas fa-eye me-2"></i>é è¦½
                    </h5>
                    <div id="previewFrame"
                        style="border: 2px solid #e0e0e0; border-radius: 8px; overflow: hidden; background: #f8f9fa; min-height: 400px; display: flex; align-items: center; justify-content: center;">
                        <div style="text-align: center; color: #6c757d;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                            <p>è¼‰å…¥é è¦½ä¸­...</p>
                        </div>
                    </div>
                </div>

                <!-- Submissions Display -->
                <div class="mt-5">
                    <h4
                        style="color: #333; font-weight: 600; margin-bottom: 20px; border-bottom: 2px solid #28a745; padding-bottom: 10px;">
                        <i class="fas fa-users me-2"></i>å­¸ç”Ÿä½œå“å±•ç¤º
                    </h4>
                    <div id="submissionsContainer" class="row g-4">
                        <!-- Submissions will be loaded here -->
                        <div class="col-12 text-center" id="loadingSubmissions" style="color: #6c757d; padding: 40px;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                            <p>è¼‰å…¥å­¸ç”Ÿä½œå“ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const image1Container = document.getElementById('image1-container');
            const image2Container = document.getElementById('image2-container');

            // Track which image is currently large (true = image1 is large, false = image2 is large)
            let image1IsLarge = true;

            function handleImageClick(event, container, imageId) {
                console.log('Clicked container:', imageId);
                console.log('Current state - image1IsLarge:', image1IsLarge);

                // Check if the clicked container is the currently large one
                const isCurrentImageLarge = (container === image1Container && image1IsLarge) ||
                    (container === image2Container && !image1IsLarge);

                console.log('Is large:', isCurrentImageLarge);

                if (isCurrentImageLarge) {
                    // If clicking the large image, show modal
                    console.log('Opening modal for:', imageId);
                    showImageModal(imageId);
                } else {
                    // If clicking the small image, make it large
                    console.log('Swapping sizes');
                    swapImageSizes();
                }
            }

            function swapImageSizes() {
                const currentFlex1 = image1Container.style.flex;
                const currentFlex2 = image2Container.style.flex;

                // Swap the flex values
                image1Container.style.flex = currentFlex2 || '1';
                image2Container.style.flex = currentFlex1 || '2';

                // Update the state tracking
                image1IsLarge = !image1IsLarge;
                console.log('Swapped sizes. New state - image1IsLarge:', image1IsLarge);
            }

            function showImageModal(imageId) {
                console.log('showImageModal called with:', imageId);

                const image = document.getElementById(imageId);
                if (!image) {
                    console.error('Image not found:', imageId);
                    return;
                }

                const imageSrc = image.src;
                console.log('Image source:', imageSrc);

                // Create modal HTML
                const modalHTML = `
                    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-fullscreen">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="imageModalLabel">å…¨è¢å¹•åœ–ç‰‡æª¢è¦–</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body d-flex justify-content-center align-items-center position-relative" style="background-color: #f8f9fa;">
                                    <img src="${imageSrc}" class="img-fluid" alt="Full size image" 
                                         style="max-width: 95vw; max-height: 90vh; width: auto; height: auto; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Remove existing modal if any
                const existingModal = document.getElementById('imageModal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Add modal to body
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                console.log('Modal HTML added to body');

                // Show modal
                try {
                    const modalElement = document.getElementById('imageModal');
                    if (modalElement) {
                        const modal = new bootstrap.Modal(modalElement);
                        modal.show();
                        console.log('Modal shown successfully');
                    } else {
                        console.error('Modal element not found after creation');
                    }
                } catch (error) {
                    console.error('Error showing modal:', error);
                }

                // Clean up modal after it's hidden
                document.getElementById('imageModal').addEventListener('hidden.bs.modal', function () {
                    this.remove();
                });
            }

            // Add click event listeners to both containers
            image1Container.addEventListener('click', (e) => handleImageClick(e, image1Container, 'image1'));
            image2Container.addEventListener('click', (e) => handleImageClick(e, image2Container, 'image2'));
        });


    </script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/e067495424.js" crossorigin="anonymous"></script>
    <script src="script.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-analytics.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-storage.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc, updateDoc, getDoc, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAOiceU8Lm9nVV3vtC78BVSdFSBbCS1aTY",
            authDomain: "aka-iw10-250825.firebaseapp.com",
            projectId: "aka-iw10-250825",
            storageBucket: "aka-iw10-250825.firebasestorage.app",
            messagingSenderId: "759880857162",
            appId: "1:759880857162:web:adbf8a30ca00a2e3b7d8b3",
            measurementId: "G-VW9JL4FJJ2"
        };

        // Initialize Firebase
        let app, storage;
        try {
            app = initializeApp(firebaseConfig);
            console.log("Firebase initialized successfully");

            // Initialize Analytics
            try {
                const analytics = getAnalytics(app);
                console.log("Firebase Analytics initialized");
            } catch (analyticsError) {
                console.warn("Analytics initialization failed:", analyticsError);
            }

            // Initialize Storage
            try {
                storage = getStorage(app);
                console.log("Firebase Storage initialized successfully");

                // Test storage access
                const testRef = ref(storage, ".connection_test");
                console.log("Storage reference created:", testRef);
            } catch (storageError) {
                console.error("Storage initialization failed:", storageError);
                alert("Firebaseå­˜å„²åˆå§‹åŒ–å¤±æ•—ï¼Œä¸Šå‚³åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨");
            }

            // Initialize Firestore
            try {
                const db = getFirestore(app);
                console.log("Firestore initialized successfully");
                window.fbDB = db;
            } catch (firestoreError) {
                console.error("Firestore initialization failed:", firestoreError);
                alert("Firestoreåˆå§‹åŒ–å¤±æ•—ï¼Œæäº¤åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨");
            }
        } catch (firebaseError) {
            console.error("Firebase initialization failed:", firebaseError);
            alert("Firebaseåˆå§‹åŒ–å¤±æ•—ï¼Œä¸Šå‚³åŠŸèƒ½ä¸å¯ç”¨");
        }

        // Make storage available globally
        window.fbStorage = storage;

        // Generate a random user ID if not already set
        if (!localStorage.getItem('currentUserId')) {
            const randomId = 'user_' + Math.random().toString(36).substring(2, 8);
            localStorage.setItem('currentUserId', randomId);
            console.log('Generated random user ID:', randomId);
        }

        // Function to get emoji for user ID
        function getEmojiForUserId(userId) {
            const kidFriendlyEmojis = [
                'ğŸŒŸ', 'ğŸŒˆ', 'ğŸ¦„', 'ğŸ±', 'ğŸ¶', 'ğŸ¦', 'ğŸ¼', 'ğŸ¨', 'ğŸ¦Š', 'ğŸ¦‹',
                'ğŸŒ¸', 'ğŸŒº', 'ğŸŒ»', 'ğŸŒ', 'â­', 'ğŸŒ™', 'â˜€ï¸', 'ğŸŒ¤ï¸', 'ğŸŒº', 'ğŸŒ·',
                'ğŸ€', 'ğŸŒ±', 'ğŸŒ³', 'ğŸŒ´', 'ğŸŒµ', 'ğŸŒ¿', 'ğŸ„', 'ğŸŒ¼', 'ğŸŒ»', 'ğŸŒ¹',
                'ğŸ¨', 'ğŸ­', 'ğŸª', 'ğŸ¯', 'ğŸ²'
            ];
            // Subtract 1 from userId since we want to start from 0
            const index = (parseInt(userId) - 1) % kidFriendlyEmojis.length;
            return kidFriendlyEmojis[index];
        }

        // Update user ID display in the navbar
        const userIdDisplay = document.getElementById('userIdDisplay');
        const currentUserId = localStorage.getItem('currentUserId');

        if (userIdDisplay && currentUserId) {
            userIdDisplay.textContent = `User ID: ${currentUserId} ${getEmojiForUserId(currentUserId)}`;
            userIdDisplay.classList.remove('d-none');
        }

        const nameInput = document.getElementById('name_1');
        if (nameInput) {
            nameInput.value = currentUserId;
        }

        const items = document.querySelectorAll('.text-item');
        const buttons = document.querySelectorAll('.btn');
        let currentIndex = 0;
        let rotationInterval; // Variable to hold the interval

        function rotateText() {
            items[currentIndex]?.classList.remove('active');
            currentIndex = (currentIndex + 1) % items.length;
            items[currentIndex]?.classList.add('active');
        }

        function showText(index) {
            const newIndex = parseInt(index);
            if (isNaN(newIndex) || newIndex < 0 || newIndex >= items.length) {
                console.warn('Invalid index:', index);
                return;
            }

            items[currentIndex]?.classList.remove('active');
            currentIndex = newIndex;
            items[currentIndex]?.classList.add('active');
        }

        function startRotation() {
            rotationInterval = setInterval(rotateText, 5000); // Change text every 3 seconds
        }

        function stopRotation() {
            clearInterval(rotationInterval); // Stop the rotation
        }

        // Start the rotation on page load
        startRotation();

        buttons.forEach(button => {
            button.addEventListener('mouseover', () => {
                stopRotation(); // Stop rotation on mouse over
                showText(button.getAttribute('data-index'));
            });
            button.addEventListener('mouseleave', () => {
                startRotation(); // Resume rotation on mouse leave
            });
        });

        // Font size variable for the rich text editor
        window.editorFontSize = 16; // Default font size (moved to global scope to avoid redeclaration)

        // Form handling for Prompt submissions
        const form1 = document.getElementById('dataForm_ws1');

        if (form1) {
            form1.addEventListener('submit', async function (event) {
                event.preventDefault();
                const textarea = form1.querySelector('textarea');
                const label = form1.querySelector('label');
                const promptText = textarea.value.trim();

                if (!promptText) {
                    alert('è«‹è¼¸å…¥Promptå…§å®¹å†æäº¤');
                    return;
                }

                const currentUserId = localStorage.getItem('currentUserId');
                if (!currentUserId) {
                    alert('è«‹å…ˆç™»å…¥æˆ–è¨­ç½®ç”¨æˆ¶ID');
                    return;
                }

                try {
                    // Show loading state
                    const submitBtn = form1.querySelector('button[type="submit"]');
                    const originalBtnText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'æäº¤ä¸­...';

                    // Add document to Firestore
                    const promptsCollection = collection(window.fbDB, 'prompts');
                    const newPrompt = {
                        text: promptText,
                        userId: currentUserId,
                        timestamp: serverTimestamp(),
                        createdAt: new Date().toISOString() // Backup for sorting if serverTimestamp fails
                    };

                    await addDoc(promptsCollection, newPrompt);

                    // Clear the form and show success message
                    textarea.value = '';
                    label.textContent = 'æˆåŠŸæäº¤! å¤šè¬æ‚¨çš„æç¤ºã€‚';

                    // Show alert to confirm submission
                    alert('æäº¤æˆåŠŸï¼');

                    // Refresh the prompts display
                    loadPrompts();
                } catch (error) {
                    console.error('Error submitting prompt:', error);
                    alert(`æäº¤å¤±æ•—: ${error.message}`);
                } finally {
                    // Restore button state
                    const submitBtn = form1.querySelector('button[type="submit"]');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'æäº¤æŒ‡ç¤º';
                }
            });
        }

        // In case dataForm_ws4 exists elsewhere in the document, keep a simplified version
        const form2 = document.getElementById('dataForm_ws4');
        if (form2) {
            form2.addEventListener('submit', function (event) {
                event.preventDefault();
                const input = form2.querySelector('input[type="url"]');
                const label = form2.querySelector('label');

                if (input) {
                    input.value = '';
                    if (label) label.textContent = 'æˆåŠŸæäº¤!';
                    alert('æäº¤æˆåŠŸï¼');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            const nameInput = document.getElementById('name');
            const currentUserId = localStorage.getItem('currentUserId');
            if (nameInput) {
                nameInput.value = currentUserId;
            }

            // Add keyboard event listeners
            document.addEventListener('keydown', function (e) {
                if (e.key === 'ArrowRight' && e.shiftKey) {
                    nameInput.classList.remove('d-none');
                }
            });

            document.addEventListener('keyup', function (e) {
                if (e.key === 'ArrowRight' && e.shiftKey) {
                    nameInput.classList.add('d-none');
                }
            });
        });

        document.addEventListener('DOMContentLoaded', function () {
            const imageUpload = document.getElementById('imageUpload');
            const imagePreview = document.getElementById('imagePreview');
            const uploadButton = document.getElementById('uploadButton');
            const imageName = document.getElementById('imageName');
            const uploadStatus = document.getElementById('uploadStatus');
            const uploadStatusMessage = document.getElementById('uploadStatusMessage');
            const uploadProgress = document.getElementById('uploadProgress');
            const displayUserId = document.getElementById('displayUserId');
            const changeUserIdBtn = document.getElementById('changeUserIdBtn');
            const testConnectionBtn = document.getElementById('testConnectionBtn');

            // Initialize prompts display
            loadPrompts();

            // Handle prompt edit modal
            const savePromptEditBtn = document.getElementById('savePromptEdit');
            if (savePromptEditBtn) {
                savePromptEditBtn.addEventListener('click', updatePrompt);
            }

            // Set up refresh button
            const refreshBtn = document.getElementById('refreshPrompts');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    refreshBtn.disabled = true;
                    const icon = refreshBtn.querySelector('i');
                    icon.classList.add('fa-spin');
                    loadPrompts().finally(() => {
                        setTimeout(() => {
                            refreshBtn.disabled = false;
                            icon.classList.remove('fa-spin');
                        }, 500);
                    });
                });
            }

            // Set up sort buttons
            const sortNewestBtn = document.getElementById('sortNewest');
            const sortOldestBtn = document.getElementById('sortOldest');

            if (sortNewestBtn) {
                sortNewestBtn.addEventListener('click', () => {
                    loadPrompts('desc');
                });
            }

            if (sortOldestBtn) {
                sortOldestBtn.addEventListener('click', () => {
                    loadPrompts('asc');
                });
            }

            // Function to test Firebase connectivity
            async function testFirebaseConnection() {
                if (!window.fbStorage) {
                    alert('Firebase å„²å­˜é‚„æœªåˆå§‹åŒ–');
                    return false;
                }

                try {
                    const testRef = ref(window.fbStorage, `.connection_test_${Date.now()}`);
                    const testBlob = new Blob(['connection_test'], { type: 'text/plain' });

                    // Try to upload a small test file
                    await uploadBytes(testRef, testBlob);

                    // Try to get the download URL
                    const downloadURL = await getDownloadURL(testRef);

                    console.log('Firebase connection test successful:', downloadURL);
                    alert('Firebase é€£æ¥æ¸¬è©¦æˆåŠŸï¼ä¸Šå‚³åŠŸèƒ½å·²æ­£å¸¸é‹ä½œã€‚');
                    return true;
                } catch (error) {
                    console.error('Firebase connection test failed:', error);

                    // Check if it's a permission error
                    if (error.code === 'storage/unauthorized') {
                        alert('Firebase é€£æ¥æ­£å¸¸ï¼Œä½†æ¬Šé™å—é™ã€‚è«‹è¯çµ¡ç®¡ç†å“¡ç²å–ä¸Šå‚³æ¬Šé™ã€‚');
                        return true; // Connection works, just permissions issue
                    } else {
                        alert(`Firebase é€£æ¥æ¸¬è©¦å¤±æ•—: ${error.message}`);
                        return false;
                    }
                }
            }

            // Add event listener for test connection button
            testConnectionBtn.addEventListener('click', function () {
                testFirebaseConnection();
            });

            // Update user ID display
            function updateUserIdDisplay() {
                const currentUserId = localStorage.getItem('currentUserId') || 'æœªè¨­ç½®';
                displayUserId.textContent = currentUserId;
            }

            // Initialize user ID display
            updateUserIdDisplay();

            // Handle user ID change button
            changeUserIdBtn.addEventListener('click', function () {
                const currentUserId = localStorage.getItem('currentUserId') || '';
                const newUserId = prompt('è«‹è¼¸å…¥æ–°çš„ç”¨æˆ¶ID:', currentUserId);
                if (newUserId && newUserId.trim() !== '') {
                    localStorage.setItem('currentUserId', newUserId.trim());
                    updateUserIdDisplay();
                    alert('ç”¨æˆ¶IDå·²æ›´æ–°!');
                }
            });

            // Preview images
            imageUpload.addEventListener('change', function (e) {
                imagePreview.innerHTML = ''; // Clear existing previews

                [...e.target.files].forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const preview = document.createElement('div');
                        preview.className = 'position-relative';
                        preview.innerHTML = `
                                                        <img src="${e.target.result}" style="max-width: 200px; max-height: 200px; object-fit: contain;">
                                                `;
                        imagePreview.appendChild(preview);
                    }
                    reader.readAsDataURL(file);
                });
            });

            // Handle upload
            uploadButton.addEventListener('click', async function () {
                const files = imageUpload.files;
                const currentUserId = localStorage.getItem('currentUserId');

                // Check for user ID
                if (!currentUserId) {
                    // Prompt the user to enter a user ID if not already set
                    const userId = prompt('è«‹è¼¸å…¥æ‚¨çš„ç”¨æˆ¶ID:');
                    if (!userId) {
                        alert('éœ€è¦ç”¨æˆ¶IDæ‰èƒ½ä¸Šå‚³åœ–ç‰‡');
                        return;
                    }
                    localStorage.setItem('currentUserId', userId);
                }

                if (!files.length || !imageName.value) {
                    alert('è«‹é¸æ“‡åœ–ç‰‡ä¸¦å…¥åç¨±');
                    return;
                }

                try {
                    uploadButton.disabled = true;
                    uploadButton.textContent = 'ä¸Šå‚³ä¸­...';
                    uploadStatus.classList.remove('d-none');
                    uploadStatusMessage.textContent = 'æº–å‚™ä¸Šå‚³...';

                    // Reset progress bar
                    uploadProgress.style.width = '0%';
                    uploadProgress.textContent = '0%';

                    // Test Firebase connection first
                    uploadStatusMessage.textContent = 'æª¢æŸ¥ Firebase é€£æ¥...';
                    try {
                        const testRef = ref(window.fbStorage, `.connection_test_${Date.now()}`);
                        const testBlob = new Blob(['connection_test'], { type: 'text/plain' });
                        await uploadBytes(testRef, testBlob);
                        uploadStatusMessage.textContent = 'Firebase é€£æ¥æˆåŠŸï¼Œé–‹å§‹ä¸Šå‚³...';
                    } catch (connectionError) {
                        // Check if it's a permission error
                        if (connectionError.code === 'storage/unauthorized') {
                            console.log('Firebase connection works but lacks permissions');
                            uploadStatusMessage.textContent = 'Firebase é€£æ¥æ­£å¸¸ï¼Œä½†æ¬Šé™å—é™ã€‚ç¹¼çºŒå˜—è©¦ä¸Šå‚³...';
                            // Continue with upload attempt anyway
                        } else {
                            throw new Error(`Firebase é€£æ¥å¤±æ•—: ${connectionError.message}`);
                        }
                    }

                    let successCount = 0;
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const timestamp = Date.now();
                        const fileName = `${currentUserId}_${imageName.value}_${timestamp}_${i}`;
                        const storageRef = ref(window.fbStorage, `stories/${fileName}`);

                        // Update progress status
                        const progressPercent = Math.round((i / files.length) * 100);
                        uploadProgress.style.width = `${progressPercent}%`;
                        uploadProgress.textContent = `${progressPercent}%`;
                        uploadStatusMessage.textContent = `æ­£åœ¨ä¸Šå‚³æ–‡ä»¶ ${i + 1}/${files.length}: ${file.name}`;

                        try {
                            await uploadBytes(storageRef, file);
                            const downloadURL = await getDownloadURL(storageRef);
                            console.log('File uploaded:', downloadURL);
                            successCount++;
                        } catch (fileError) {
                            console.error(`Error uploading ${file.name}:`, fileError);

                            // Check if it's a permission error
                            if (fileError.code === 'storage/unauthorized') {
                                uploadStatusMessage.textContent = `ä¸Šå‚³ ${file.name} å¤±æ•—: æ¬Šé™ä¸è¶³ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡`;
                            } else {
                                uploadStatusMessage.textContent = `ä¸Šå‚³ ${file.name} å¤±æ•—: ${fileError.message}`;
                            }
                        }
                    }

                    // Set progress to 100%
                    uploadProgress.style.width = '100%';
                    uploadProgress.textContent = '100%';

                    if (successCount === files.length) {
                        uploadStatusMessage.textContent = `å…¨éƒ¨ ${files.length} å€‹æ–‡ä»¶ä¸Šå‚³æˆåŠŸï¼`;
                        alert('åœ–ç‰‡ä¸Šå‚³æˆåŠŸï¼');
                    } else {
                        uploadStatusMessage.textContent = `æˆåŠŸä¸Šå‚³ ${successCount}/${files.length} å€‹æ–‡ä»¶ã€‚`;
                        alert(`éƒ¨åˆ†ä¸Šå‚³æˆåŠŸï¼š${successCount}/${files.length} å€‹æ–‡ä»¶`);
                    }

                    imageUpload.value = '';
                    imageName.value = '';
                    imagePreview.innerHTML = '';

                } catch (error) {
                    console.error('Upload error:', error);
                    uploadStatusMessage.textContent = `ä¸Šå‚³éŒ¯èª¤: ${error.message}`;
                    alert(`ä¸Šå‚³å¤±æ•—ï¼Œè«‹é‡è©¦: ${error.message}`);
                } finally {
                    uploadButton.disabled = false;
                    uploadButton.textContent = 'ä¸Šå‚³åœ–ç‰‡';
                    setTimeout(() => {
                        uploadStatus.classList.add('d-none'); // Hide status after a delay
                    }, 5000);
                }
            });
        });



        document.addEventListener('DOMContentLoaded', function () {
            const sectionTitle = document.getElementById('sectionTitle');
            const sections = document.querySelectorAll('.row.flex-grow-2.mt-5.fade-in');

            window.addEventListener('scroll', function () {
                // Find which section is currently in view
                let currentSection = null;
                let smallestDistance = Infinity;

                sections.forEach(section => {
                    const rect = section.getBoundingClientRect();
                    // Calculate distance from top of viewport
                    const distance = Math.abs(rect.top);

                    // Find the section closest to the top of the viewport
                    if (distance < smallestDistance) {
                        smallestDistance = distance;
                        currentSection = section;
                    }
                });

                // Update section title if we found a section
                if (currentSection) {
                    const sectionHeader = currentSection.querySelector('h4.mb-3');
                    // Show section title when any section is above the viewport
                    if (currentSection.getBoundingClientRect().top < 0) {
                        sectionTitle.textContent = sectionHeader.textContent;
                        sectionTitle.classList.remove('d-none');
                    } else {
                        sectionTitle.classList.add('d-none');
                    }
                }
            });
        });

        // Make openModal available globally
        window.openModal = function (presentationId) {
            const modal = new bootstrap.Modal(document.getElementById('presentationModal'));
            const container = document.getElementById('modalIframeContainer');

            // Define the iframe sources
            const presentations = {
                'presentation2': "https://docs.google.com/presentation/d/e/2PACX-1vR0N5eLd3d65nUFnFNtZp2HMlcOj0VPHmjnM4Jjq7u7SpTj1I-F0nrx1Np2Kiw1nQIu1-q6sJRv5R-S/pubembed?start=false&loop=false&delayms=3000"
            };

            // Create and insert the iframe
            container.innerHTML = `<iframe src="${presentations[presentationId]}" 
                                frameborder="0" 
                                width="100%" 
                                height="100%" 
                                allowfullscreen="true" 
                                mozallowfullscreen="true" 
                                webkitallowfullscreen="true">
                        </iframe>`;

            modal.show();
        };



        // Load stories from Firestore
        async function loadStories(sortDirection = 'desc') {
            const storiesContainer = document.getElementById('storiesContainer');
            const loadingStories = document.getElementById('loadingStories');

            console.log('Loading stories...', { storiesContainer: !!storiesContainer, fbDB: !!window.fbDB });

            if (!storiesContainer || !window.fbDB) {
                console.error('Missing required elements:', { storiesContainer: !!storiesContainer, fbDB: !!window.fbDB });
                return;
            }

            try {
                // Show loading indicator
                if (loadingStories) {
                    loadingStories.classList.remove('d-none');
                }

                // Clear existing content
                storiesContainer.innerHTML = '';

                // Get current user ID for permission checks
                const currentUserId = localStorage.getItem('currentUserId') || '';
                const isAdmin = currentUserId === 'M514';

                // Query stories, ordered by timestamp
                const storiesCollection = collection(window.fbDB, 'stories');
                const q = query(storiesCollection, orderBy('createdAt', sortDirection));
                const querySnapshot = await getDocs(q);

                // Hide loading indicator
                if (loadingStories) {
                    loadingStories.classList.add('d-none');
                }

                if (querySnapshot.empty) {
                    const noStoriesMsg = document.createElement('div');
                    noStoriesMsg.className = 'alert alert-secondary text-center';
                    noStoriesMsg.textContent = 'å°šæœªæœ‰äººæäº¤æ•…äº‹çµæ§‹';
                    storiesContainer.appendChild(noStoriesMsg);
                    return;
                }

                // Process each story document
                console.log(`Found ${querySnapshot.size} stories`);
                querySnapshot.forEach(doc => {
                    const storyData = doc.data();
                    const storyId = doc.id;
                    const canEdit = isAdmin || storyData.userId === currentUserId;

                    console.log('Processing story:', { storyId, userId: storyData.userId, content: storyData.content });

                    // Format timestamp
                    let timestampStr = 'å‰›å‰›';
                    if (storyData.timestamp) {
                        const timestamp = storyData.timestamp.toDate();
                        timestampStr = new Intl.DateTimeFormat('zh-HK', {
                            year: 'numeric',
                            month: 'numeric',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }).format(timestamp);
                    }

                    // Create story card
                    const storyCard = document.createElement('div');
                    storyCard.className = 'card mb-3 story-card';
                    storyCard.innerHTML = `
                        <div class="card-header d-flex justify-content-between align-items-center bg-light">
                            <span class="fw-semibold"><i class="fas fa-user-circle me-2"></i>${storyData.userId || 'åŒ¿å'}</span>
                            <small class="text-muted"><i class="far fa-clock me-1"></i>${timestampStr}</small>
                        </div>
                        <div class="card-body">
                            <div class="story-content">
                                <h6 class="text-primary mb-2"><i class="fas fa-book me-2"></i>æ•…äº‹å…§å®¹</h6>
                                <div class="card-text" style="white-space: pre-wrap; line-height: 1.6;">${storyData.content.replace(/\n/g, '<br>')}</div>
                            </div>
                            ${canEdit ? `
                            <div class="text-end mt-3">
                                <button class="btn btn-sm btn-outline-danger delete-story-btn" data-id="${storyId}">
                                    <i class="fas fa-trash me-1"></i>åˆªé™¤
                                </button>
                            </div>
                            ` : ''}
                        </div>
                    `;

                    storiesContainer.appendChild(storyCard);

                    // Add delete functionality
                    const deleteBtn = storyCard.querySelector('.delete-story-btn');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', function () {
                            const storyId = this.getAttribute('data-id');
                            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ•…äº‹å—ï¼Ÿ')) {
                                deleteStory(storyId);
                            }
                        });
                    }
                });

            } catch (error) {
                console.error('Error loading stories:', error);
                if (loadingStories) {
                    loadingStories.classList.add('d-none');
                }

                const errorMsg = document.createElement('div');
                errorMsg.className = 'alert alert-danger';

                // Handle Firebase permission errors
                if (error.code === 'permission-denied' || error.message.includes('permission')) {
                    errorMsg.textContent = 'Firebase æ¬Šé™ä¸è¶³ã€‚è«‹è¯çµ¡ç®¡ç†å“¡ç²å–è®€å–æ¬Šé™ã€‚';
                } else {
                    errorMsg.textContent = `è¼‰å…¥æ•…äº‹å¤±æ•—: ${error.message}`;
                }

                storiesContainer.appendChild(errorMsg);
            }
        }

        // Delete story function
        async function deleteStory(storyId) {
            try {
                const storyRef = doc(window.fbDB, 'stories', storyId);
                await deleteDoc(storyRef);
                alert('æ•…äº‹å·²åˆªé™¤');
                loadStories();
            } catch (error) {
                console.error('Error deleting story:', error);
                alert(`åˆªé™¤å¤±æ•—: ${error.message}`);
            }
        }

        // Initialize story functionality when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            // Story Structure Form Handling
            const storyStructureForm = document.getElementById('storyStructureForm');
            if (storyStructureForm) {
                storyStructureForm.addEventListener('submit', async function (event) {
                    event.preventDefault();

                    const storyContent = document.getElementById('storyContent').value.trim();

                    // Check if story content is provided
                    if (!storyContent) {
                        alert('è«‹å¡«å¯«æ•…äº‹å…§å®¹');
                        return;
                    }

                    const currentUserId = localStorage.getItem('currentUserId');
                    if (!currentUserId) {
                        alert('è«‹å…ˆç™»å…¥æˆ–è¨­ç½®ç”¨æˆ¶ID');
                        return;
                    }

                    try {
                        // Show loading state
                        const submitBtn = storyStructureForm.querySelector('button[type="submit"]');
                        const originalBtnText = submitBtn.innerHTML;
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>æäº¤ä¸­...';

                        console.log('Submitting story:', { content: storyContent, userId: currentUserId });

                        // Check if Firebase is available
                        if (!window.fbDB) {
                            throw new Error('Firebase æœªåˆå§‹åŒ–ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦');
                        }

                        // Add story to Firestore
                        const storiesCollection = collection(window.fbDB, 'stories');
                        const newStory = {
                            content: storyContent,
                            userId: currentUserId,
                            timestamp: serverTimestamp(),
                            createdAt: new Date().toISOString()
                        };

                        console.log('Adding story to Firestore:', newStory);
                        const docRef = await addDoc(storiesCollection, newStory);
                        console.log('Story saved with ID:', docRef.id);

                        // Clear the form
                        storyStructureForm.reset();

                        // Show success message
                        alert('æ•…äº‹çµæ§‹ä¿å­˜æˆåŠŸï¼');

                        // Refresh the stories display
                        loadStories();

                    } catch (error) {
                        console.error('Error saving story:', error);

                        // Handle Firebase permission errors
                        if (error.code === 'permission-denied' || error.message.includes('permission')) {
                            alert('Firebase æ¬Šé™ä¸è¶³ã€‚è«‹è¯çµ¡ç®¡ç†å“¡ç²å–å¯«å…¥æ¬Šé™ã€‚');
                        } else {
                            alert(`ä¿å­˜å¤±æ•—: ${error.message}`);
                        }
                    } finally {
                        // Restore button state
                        const submitBtn = storyStructureForm.querySelector('button[type="submit"]');
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalBtnText;
                        }
                    }
                });
            } else {
                console.error('Story structure form not found');
            }

            // Load stories on page load
            loadStories();

            // Set up refresh button
            const refreshStoriesBtn = document.getElementById('refreshStories');
            if (refreshStoriesBtn) {
                refreshStoriesBtn.addEventListener('click', () => {
                    refreshStoriesBtn.disabled = true;
                    const icon = refreshStoriesBtn.querySelector('i');
                    icon.classList.add('fa-spin');
                    loadStories().finally(() => {
                        setTimeout(() => {
                            refreshStoriesBtn.disabled = false;
                            icon.classList.remove('fa-spin');
                        }, 500);
                    });
                });
            }

            // Set up sort button
            const sortStoriesNewestBtn = document.getElementById('sortStoriesNewest');
            if (sortStoriesNewestBtn) {
                sortStoriesNewestBtn.addEventListener('click', () => {
                    loadStories('desc');
                });
            }
        });

        // Add copyToClipboard function if it doesn't exist
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('å·²è¤‡è£½åˆ°å‰ªè²¼æ¿');
            }).catch(err => {
                console.error('è¤‡è£½å¤±æ•—:', err);
                alert('è¤‡è£½å¤±æ•—');
            });
        }

        // Testing code for debugging purposes
        console.log("Script initialized");

        // Excalidraw Submission System
        document.addEventListener('DOMContentLoaded', function () {
            const submitBtn = document.getElementById('submitBtn');
            const excalidrawLink = document.getElementById('excalidrawLink');
            const previewBtn = document.getElementById('previewBtn');
            const previewSection = document.getElementById('previewSection');
            const previewFrame = document.getElementById('previewFrame');
            const submissionsContainer = document.getElementById('submissionsContainer');
            const loadingSubmissions = document.getElementById('loadingSubmissions');

            if (!submitBtn || !excalidrawLink || !previewBtn || !previewSection || !previewFrame || !submissionsContainer || !loadingSubmissions) {
                console.log('Excalidraw elements not found, skipping initialization');
                return;
            }

            console.log('Initializing Excalidraw system...');

            // Preview functionality
            previewBtn.addEventListener('click', function () {
                const link = excalidrawLink.value.trim();
                if (!link) {
                    alert('è«‹å…ˆè¼¸å…¥ Excalidraw é€£çµ');
                    return;
                }

                if (!isValidExcalidrawLink(link)) {
                    alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Excalidraw é€£çµ');
                    return;
                }

                previewSection.style.display = 'block';
                previewFrame.innerHTML = `
                    <iframe src="${link}" 
                            style="width: 100%; height: 500px; border: none;" 
                            allowfullscreen>
                    </iframe>
                `;
            });

            // Submit functionality
            submitBtn.addEventListener('click', async function () {
                const link = excalidrawLink.value.trim();
                const currentUserId = localStorage.getItem('currentUserId');

                if (!link) {
                    alert('è«‹å…ˆè¼¸å…¥ Excalidraw é€£çµ');
                    return;
                }

                if (!isValidExcalidrawLink(link)) {
                    alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Excalidraw é€£çµ');
                    return;
                }

                if (!currentUserId) {
                    alert('è«‹å…ˆè¨­ç½®ç”¨æˆ¶ID');
                    return;
                }

                try {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>æäº¤ä¸­...';

                    // Add submission to Firestore
                    const submissionsCollection = collection(window.fbDB, 'image_notes_submissions');
                    const newSubmission = {
                        link: link,
                        userId: currentUserId,
                        timestamp: serverTimestamp(),
                        createdAt: new Date().toISOString()
                    };

                    await addDoc(submissionsCollection, newSubmission);

                    // Clear form
                    excalidrawLink.value = '';
                    previewSection.style.display = 'none';
                    previewFrame.innerHTML = '';

                    alert('ä½œå“æäº¤æˆåŠŸï¼');

                    // Refresh submissions display
                    loadSubmissions();

                } catch (error) {
                    console.error('Error submitting:', error);
                    alert(`æäº¤å¤±æ•—: ${error.message}`);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>æäº¤ä½œå“';
                }
            });

            // Load submissions
            async function loadSubmissions() {
                try {
                    console.log('Loading Image Notes submissions...');
                    const submissionsCollection = collection(window.fbDB, 'image_notes_submissions');
                    const q = query(submissionsCollection, orderBy('createdAt', 'desc'));
                    const querySnapshot = await getDocs(q);

                    // Hide loading
                    loadingSubmissions.style.display = 'none';

                    if (querySnapshot.empty) {
                        submissionsContainer.innerHTML = `
                            <div class="col-12 text-center" style="color: #6c757d; padding: 40px;">
                                <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                                <p>å°šæœªæœ‰å­¸ç”Ÿæäº¤ä½œå“</p>
                            </div>
                        `;
                        return;
                    }

                    // Get current user ID for permission checks
                    const currentUserId = localStorage.getItem('currentUserId') || '';
                    const adminIds = ['180', '280', '380', '480', '580'];
                    const isAdmin = adminIds.includes(currentUserId);

                    submissionsContainer.innerHTML = '';
                    querySnapshot.forEach(doc => {
                        const submission = doc.data();
                        const submissionCard = createSubmissionCard(submission, doc.id, currentUserId, isAdmin);
                        submissionsContainer.appendChild(submissionCard);
                    });

                    console.log(`Loaded ${querySnapshot.size} submissions`);

                } catch (error) {
                    console.error('Error loading submissions:', error);
                    loadingSubmissions.innerHTML = `
                        <div class="col-12 text-center" style="color: #dc3545; padding: 40px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                            <p>è¼‰å…¥å¤±æ•—: ${error.message}</p>
                        </div>
                    `;
                }
            }

            // Create submission card
            function createSubmissionCard(submission, docId, currentUserId, isAdmin) {
                // Check if user can delete this submission (admin or own submission)
                const canDelete = isAdmin || submission.userId === currentUserId;

                const card = document.createElement('div');
                card.className = 'col-md-6 col-lg-4';
                card.innerHTML = `
                    <div class="card h-100" style="border: 1px solid #e0e0e0; border-radius: 12px; overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease;">
                        <div class="card-header" style="background-color: #f8f9fa; border-bottom: 1px solid #e0e0e0; padding: 15px;">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-semibold" style="color: #333;">
                                    <i class="fas fa-user-circle me-2"></i>${submission.userId || 'åŒ¿å'}
                                </span>
                                <small class="text-muted">
                                    <i class="far fa-clock me-1"></i>${formatTimestamp(submission.timestamp)}
                                </small>
                            </div>
                        </div>
                        <div class="card-body p-0" style="height: 300px;">
                            <iframe src="${submission.link}" 
                                    style="width: 100%; height: 100%; border: none;" 
                                    allowfullscreen>
                            </iframe>
                        </div>
                        <div class="card-footer" style="background-color: #fff; border-top: 1px solid #e0e0e0; padding: 15px;">
                            <div class="d-flex justify-content-between align-items-center">
                                <a href="${submission.link}" target="_blank" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-external-link-alt me-1"></i>åœ¨æ–°è¦–çª—é–‹å•Ÿ
                                </a>
                                ${canDelete ? `
                                <button class="btn btn-sm btn-outline-danger delete-submission" data-id="${docId}">
                                    <i class="fas fa-trash me-1"></i>åˆªé™¤
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;

                // Add delete functionality only if user can delete
                if (canDelete) {
                    const deleteBtn = card.querySelector('.delete-submission');
                    deleteBtn.addEventListener('click', function () {
                        if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ä½œå“å—ï¼Ÿ')) {
                            deleteSubmission(docId);
                        }
                    });
                }

                return card;
            }

            // Delete submission
            async function deleteSubmission(docId) {
                try {
                    const submissionRef = doc(window.fbDB, 'image_notes_submissions', docId);
                    await deleteDoc(submissionRef);
                    alert('ä½œå“å·²åˆªé™¤');
                    loadSubmissions();
                } catch (error) {
                    console.error('Error deleting submission:', error);
                    alert(`åˆªé™¤å¤±æ•—: ${error.message}`);
                }
            }

            // Helper functions
            function isValidExcalidrawLink(link) {
                return link.includes('excalidraw.com') || link.includes('excalidraw.app');
            }

            function formatTimestamp(timestamp) {
                if (!timestamp) return 'å‰›å‰›';
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return new Intl.DateTimeFormat('zh-HK', {
                    year: 'numeric',
                    month: 'numeric',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }).format(date);
            }

            // Initialize
            console.log('Starting Image Notes submissions load...');
            loadSubmissions();
        });

    </script>
    <script>
        // Use the global font size variable declared above
        function changeFontSize(change) {
            window.editorFontSize += change; // Adjust the font size using the global variable
            document.getElementById('richTextInput').style.fontSize = window.editorFontSize + 'px';
        }
    </script>
    <script>
        // Add all the prompt handling functions to the global window object

        // Load prompts from Firestore and display them
        async function loadPrompts(sortDirection = 'desc') {
            const promptLogbook = document.getElementById('promptLogbook');
            const loadingPrompts = document.getElementById('loadingPrompts');

            if (!promptLogbook || !window.fbDB) return;

            try {
                // Show loading indicator
                if (loadingPrompts) {
                    loadingPrompts.style.display = 'block';
                }

                // Clear existing content except loading indicator
                Array.from(promptLogbook.children).forEach(child => {
                    if (child.id !== 'loadingPrompts') {
                        promptLogbook.removeChild(child);
                    }
                });

                // Get current user ID for permission checks
                const currentUserId = localStorage.getItem('currentUserId') || '';
                const isAdmin = currentUserId === 'M514';

                // Import required functions from Firebase
                const { collection, query, orderBy, getDocs, doc, deleteDoc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js");

                // Query prompts, ordered by timestamp
                const promptsCollection = collection(window.fbDB, 'prompts');
                const q = query(promptsCollection, orderBy('createdAt', sortDirection));
                const querySnapshot = await getDocs(q);

                // Hide loading indicator if no prompts found
                if (querySnapshot.empty && loadingPrompts) {
                    loadingPrompts.style.display = 'none';

                    // Show "no prompts" message
                    const noPromptsMsg = document.createElement('div');
                    noPromptsMsg.className = 'alert alert-secondary text-center';
                    noPromptsMsg.textContent = 'å°šæœªæœ‰äººæäº¤Prompt';
                    promptLogbook.appendChild(noPromptsMsg);
                    return;
                }

                // Process each prompt document
                querySnapshot.forEach(doc => {
                    const promptData = doc.data();
                    const promptId = doc.id;
                    const canEdit = isAdmin || promptData.userId === currentUserId;

                    // Format timestamp
                    let timestampStr = 'å‰›å‰›';
                    if (promptData.timestamp) {
                        const timestamp = promptData.timestamp.toDate();
                        timestampStr = new Intl.DateTimeFormat('zh-HK', {
                            year: 'numeric',
                            month: 'numeric',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }).format(timestamp);
                    }

                    // Create prompt card
                    const promptCard = document.createElement('div');
                    promptCard.className = 'card mb-3 prompt-card';
                    promptCard.innerHTML = `
                                <div class="card-header d-flex justify-content-between align-items-center bg-light">
                                    <span class="fw-semibold"><i class="fas fa-user-circle me-2"></i>${promptData.userId || 'åŒ¿å'}</span>
                                    <small class="text-muted"><i class="far fa-clock me-1"></i>${timestampStr}</small>
                                </div>
                                <div class="card-body position-relative">
                                    <div class="action-buttons position-absolute top-0 end-0 mt-2 me-2 d-flex gap-1">
                                        <button class="btn btn-sm btn-light rounded-circle copy-btn" 
                                                data-prompt="${escape(promptData.text)}" 
                                                data-bs-toggle="tooltip" data-bs-placement="top" title="è¤‡è£½">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                        ${canEdit ? `
                                        <button class="btn btn-sm btn-light rounded-circle edit-btn" 
                                                data-id="${promptId}" 
                                                data-bs-toggle="tooltip" data-bs-placement="top" title="ç·¨è¼¯">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-light rounded-circle delete-btn" 
                                                data-id="${promptId}"
                                                data-bs-toggle="tooltip" data-bs-placement="top" title="åˆªé™¤">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        ` : ''}
                                    </div>
                                    <p class="card-text pe-5">${promptData.text.replace(/\n/g, '<br>')}</p>
                                </div>
                            `;

                    // Add event listeners
                    promptLogbook.appendChild(promptCard);

                    // Initialize tooltips
                    const tooltipTriggerList = promptCard.querySelectorAll('[data-bs-toggle="tooltip"]');
                    tooltipTriggerList.forEach(tooltipTriggerEl => {
                        new bootstrap.Tooltip(tooltipTriggerEl, {
                            trigger: 'hover'
                        });
                    });

                    // Copy button
                    const copyBtn = promptCard.querySelector('.copy-btn');
                    if (copyBtn) {
                        copyBtn.addEventListener('click', function () {
                            const promptText = unescape(this.getAttribute('data-prompt'));
                            copyToClipboard(promptText);
                        });
                    }

                    // Edit button
                    const editBtn = promptCard.querySelector('.edit-btn');
                    if (editBtn) {
                        editBtn.addEventListener('click', function () {
                            const promptId = this.getAttribute('data-id');
                            openEditModal(promptId, promptData.text);
                        });
                    }

                    // Delete button
                    const deleteBtn = promptCard.querySelector('.delete-btn');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', function () {
                            const promptId = this.getAttribute('data-id');
                            deletePrompt(promptId);
                        });
                    }
                });

                // Hide loading indicator
                if (loadingPrompts) {
                    loadingPrompts.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading prompts:', error);
                if (loadingPrompts) {
                    loadingPrompts.style.display = 'none';
                }

                const errorMsg = document.createElement('div');
                errorMsg.className = 'alert alert-danger';
                errorMsg.textContent = `è¼‰å…¥Promptå¤±æ•—: ${error.message}`;
                promptLogbook.appendChild(errorMsg);
            }


        }
    </script>
</body>

</html>